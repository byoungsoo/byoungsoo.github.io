---
layout: post
title: "Kubernetes Workloads"
author: "Bys"
category: incubator
date: 2023-03-07 01:00:00
tags: incubator
---

# [Kubernetes Workloads](https://kubernetes.io/docs/concepts/workloads/)
WorkloadsëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ êµ¬ë™ë˜ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ë‹¤. ì›Œí¬ë¡œë“œëŠ” Podì—ì„œ ì‹¤í–‰í•œë‹¤. PodëŠ” Kubernetes clusterì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ì§‘í•©ì„ ë‚˜íƒ€ë‚¸ë‹¤. 

KubernetesëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì—¬ëŸ¬ build-in ì›Œí¬ë¡œë“œ ë¦¬ì†ŒìŠ¤ë¥¼ ì œê³µí•œë‹¤.  

- Deployment and ReplicaSet  
DeploymentëŠ” stateless application workloadë¥¼ ê´€ë¦¬í•˜ê¸°ì— ì í•©í•˜ë‹¤.  

- StatefulSet  
Stateë¥¼ ì¶”ì í•˜ëŠ” í•˜ë‚˜ ì´ìƒì˜ íŒŒë“œë¥¼ ë™ì‘í•˜ê²Œ í•´ì¤€ë‹¤. ë§Œì•½ workloadê°€ ë°ì´í„°ë¥¼ ê¸°ë¡í•˜ëŠ” ê²½ìš° StatefulSetì„ ì‹¤í–‰í•˜ëŠ”ê²Œ ì í•©í•˜ë‹¤. 

- DaemonSet  
DaemonSetì€ ë…¸ë“œ-ë¡œì»¬ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” Podsë¥¼ ì •ì˜í•œë‹¤.  
  
- Job and CronJob  
Jobê³¼ CronJobì€ ì‹¤í–‰ ì™„ë£Œ í›„ ì¤‘ë‹¨ë˜ëŠ” ì‘ì—…ì„ ì •ì˜í•œë‹¤.  


## 1. [Pods](https://kubernetes.io/docs/concepts/workloads/pods/)  
PodsëŠ” kubernetesì—ì„œ ê°€ì¥ ì‘ì€ ë°°í¬ê°€ëŠ¥í•œ ë‹¨ìœ„ì´ë©° ì»¨í…Œì´ë„ˆì˜ ê·¸ë£¹ì´ë‹¤. ì´ ê·¸ë£¹ì€ ìŠ¤í† ë¦¬ì§€ ë° ë„¤íŠ¸ì›Œí¬ë¥¼ ê³µìœ í•˜ê³  ì»¨í…Œì´ë„ˆë¥¼ êµ¬ë™í•˜ëŠ” ë°©ì‹ì— ëŒ€í•œ specificationì„ ê°–ëŠ”ë‹¤. 

Pods in a Kubernetes cluster are used in two main ways:  
 - Pods that run a single container.  
 - Pods that run multiple containers that need to work together.  
   - í•˜ë‚˜ì˜ Podsì—ì„œ multiple containersë¥¼ ì‹¤í–‰í•˜ëŠ” ê²½ìš°ëŠ” ê° ì»¨í…Œì´ë„ˆê°€ tightí•˜ê²Œ ê²°í•©ë˜ì–´ ë¦¬ì†ŒìŠ¤ë¥¼ ê³µìœ í•´ì•¼ í•˜ëŠ” ê²½ìš° ì‚¬ìš©í•˜ë©° co-located containersë“¤ì€ single cohesive unit of serviceë¥¼ í˜•ì„±í•œë‹¤. 


### 2. [Pods Lifecycle](https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/)
PodsëŠ” Pending ë‹¨ê³„ì—ì„œ ì‹œì‘í•´ì„œ, Primary container ì¤‘ ì ì–´ë„ í•˜ë‚˜ê°€ OKë¡œ ì‹œì‘í•˜ë©´ Running ë‹¨ê³„ë¥¼ í†µê³¼í•˜ê³ , ê·¸ëŸ° ë‹¤ìŒ ì»¨í…Œì´ë„ˆê°€ ì‹¤íŒ¨ë¡œ ì¢…ë£Œë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ì— ë”°ë¼ Succeeded ë˜ëŠ” Failed ë‹¨ê³„ë¡œ ì´ë™í•œë‹¤.  

íŒŒë“œê°€ ì‹¤í–‰ë˜ëŠ” ë™ì•ˆ, kubeletì€ ì¼ì¢…ì˜ ì˜¤ë¥˜ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆë‹¤. íŒŒë“œ ë‚´ì—ì„œ, ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ë‹¤ì–‘í•œ ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ ì¶”ì í•˜ê³  íŒŒë“œë¥¼ ë‹¤ì‹œ ì •ìƒ ìƒíƒœë¡œ ë§Œë“¤ê¸° ìœ„í•´ ì·¨í•  ì¡°ì¹˜ë¥¼ ê²°ì •í•œë‹¤.  
ì¿ ë²„ë„¤í‹°ìŠ¤ APIì—ì„œ íŒŒë“œëŠ” ëª…ì„¸ì™€ ì‹¤ì œ ìƒíƒœë¥¼ ëª¨ë‘ ê°€ì§„ë‹¤. Pods ì˜¤ë¸Œì íŠ¸ì˜ statusëŠ” Pods ì»¨ë””ì…˜ìœ¼ë¡œ êµ¬ì„±ëœë‹¤. ì‚¬ìš©ìì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ìœ ìš©í•œ ê²½ìš°, íŒŒë“œì˜ ì»¨ë””ì…˜ ë°ì´í„°ì— ì‚¬ìš©ì ì •ì˜ Pod readinessë¥¼ ì‚½ì…í•  ìˆ˜ë„ ìˆë‹¤. [Pod readiness ì°¸ê³ ](https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-readiness-gate)  
íŒŒë“œëŠ” íŒŒë“œì˜ ìˆ˜ëª… ì¤‘ í•œ ë²ˆë§Œ ìŠ¤ì¼€ì¤„ëœë‹¤. íŒŒë“œê°€ ë…¸ë“œì— ìŠ¤ì¼€ì¤„(í• ë‹¹)ë˜ë©´, íŒŒë“œëŠ” ì¤‘ì§€ë˜ê±°ë‚˜ ì¢…ë£Œë  ë•Œê¹Œì§€ í•´ë‹¹ ë…¸ë“œì—ì„œ ì‹¤í–‰ëœë‹¤.  

`sample describe nginx`  
```bash
Containers:
  nginx:
    Container ID:   containerd://3106dfa5b7c804a2594e46bc8a63a9818c755e0a3125a07854dee5feda161142
    Image:          nginx
    Image ID:       docker.io/library/nginx@sha256:aa0afebbb3cfa473099a62c4b32e9b3fb73ed23f2a75a65ce1d4b4f55a5c2ef2
    Port:           80/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Mon, 13 Mar 2023 09:34:11 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-4fr4z (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
```


#### Pod Phase
PhaseëŠ” íŒŒë“œì˜ ë¼ì´í”„ì‚¬ì´í´ ë‹¨ê³„ë¥¼ ê°„ë‹¨í•˜ê²Œ ìš”ì•½ í•˜ì—¬ í‘œí˜„í•œë‹¤.    
```log
                        +-----> Succeeded  
                        |  
> Pending --> Running ->|  
                        |  
                        +-----> Failed  

> Unknown 
```
- Pending: Accepted by kubernetes cluster, but one or more of the containers has not been set up and made ready to run. This includes time a Pod spends waiting to be scheduled and the time spent downloading container images.  
- Running: The Pod has been bound to a node. All of the containers have been created. At least one container is still running, or is in the process of starting or restarting.  
- Succeeded: All containers in the Pod have terminated in success, and will not be restarted.
- Failed: All containers in the Pod have terminated and at least one container has terminated in failure.
- Unknown: For some reason the state of the Pod could not be obtained. This phase typically occurs due to an error in communicating with the node where the Pod should be running. 

ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ë…¸ë“œì˜ í†µì‹ ì´ ëŠê¸°ê±°ë‚˜ ë‹¤ìš´ë˜ë©´ í•´ë‹¹ ë…¸ë“œì˜ ëª¨ë“  íŒŒë“œ ìƒíƒœë¥¼ Failedë¡œ ì²˜ë¦¬í•˜ëŠ” ì •ì±…ì„ ì ìš©í•œë‹¤.  


#### Container States
KubernetesëŠ” Podì˜ Phase ë¿ë§Œì•„ë‹ˆë¼ íŒŒë“œ ë‚´ë¶€ ê° Containerì˜ ìƒíƒœë„ ì¶”ì í•œë‹¤. [Container Lifecycle](https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/) hookì„ ì´ìš©í•˜ë©´ íŠ¹ì • ì§€ì ì—ì„œ ì‹¤í–‰í•  ì´ë²¤íŠ¸ë¥¼ íŠ¸ë¦¬ê±°ë„ ê°€ëŠ¥í•˜ë‹¤. 
ìŠ¤ì¼€ì¤„ëŸ¬ê°€ íŒŒë“œë¥¼ ë…¸ë“œì— í• ë‹¹í•˜ë©´, kubeletì€ container runtimeì„ ì‚¬ìš©í•´ Podì˜ containerë¥¼ ìƒì„±í•œë‹¤. ì´ ë•Œ containerì˜ ìƒíƒœëŠ” ì•„ë˜ì™€ ê°™ì´ 3ê°œì˜ ìƒíƒœì´ë‹¤. 

- Waiting: Running, Terminated ìƒíƒœê°€ ì•„ë‹ˆë©´ Waiting ìƒíƒœë‹¤. ì´ ìƒíƒœëŠ” ì»¨í…Œì´ë„ˆ ì‹œì‘ì´ ì™„ë£Œë˜ëŠ”ë° í•„ìš”í•œ ì‘ì—…ì„ ì§„í–‰í•œë‹¤. (Pulling image, Applying secret data ë“±)
- Running: Containerê°€ ë¬¸ì œ ì—†ì´ ì‹¤í–‰ë˜ê³  ìˆëŠ” ë‹¨ê³„. 
- Terminated:   

##### Container lifecycle hook test
`nginx-pod.yaml`  
```
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx:latest
    ports:
    - containerPort: 80
    lifecycle:
      postStart:
        exec:
          command: ["/bin/sh", "-c", "echo Hello from the postStart handler > /usr/share/message"]
      preStop:
        exec:
          command:
          - "sh"
          - "-c"
          - >
            curl localhost;
            sleep 15;
            curl localhost;
```

```bash
$ k apply -f nginx-pod.yaml

$ k delete -f nginx-pod.yaml

$ k logs -f nginx
.......
2023/04/04 03:00:22 [notice] 1#1: using the "epoll" event method
2023/04/04 03:00:22 [notice] 1#1: nginx/1.23.4
2023/04/04 03:00:22 [notice] 1#1: built by gcc 10.2.1 20210110 (Debian 10.2.1-6)
2023/04/04 03:00:22 [notice] 1#1: OS: Linux 5.10.167-147.601.amzn2.x86_64
2023/04/04 03:00:22 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576
2023/04/04 03:00:22 [notice] 1#1: start worker processes
2023/04/04 03:00:22 [notice] 1#1: start worker process 35
2023/04/04 03:00:22 [notice] 1#1: start worker process 36

# Immediately called  > curl localhost
::1 - - [04/Apr/2023:06:58:06 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/7.74.0" "-"
# Waiting 15 Sec 
# and called > curl localhost
::1 - - [04/Apr/2023:06:58:21 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/7.74.0" "-"

# Pod got signal
2023/04/04 06:58:21 [notice] 1#1: signal 3 (SIGQUIT) received, shutting down
2023/04/04 06:58:21 [notice] 36#36: gracefully shutting down
2023/04/04 06:58:21 [notice] 36#36: exiting
2023/04/04 06:58:21 [notice] 36#36: exit
2023/04/04 06:58:21 [notice] 35#35: gracefully shutting down
2023/04/04 06:58:21 [notice] 35#35: exiting
2023/04/04 06:58:21 [notice] 35#35: exit
2023/04/04 06:58:21 [notice] 1#1: signal 17 (SIGCHLD) received from 36
2023/04/04 06:58:21 [notice] 1#1: worker process 35 exited with code 0
2023/04/04 06:58:21 [notice] 1#1: worker process 36 exited with code 0
2023/04/04 06:58:21 [notice] 1#1: exit
```
ì—¬ê¸°ì„œ sleepì„ 20ì´ˆë¡œ ë³€ê²½í•˜ë©´ curl ìˆ˜í–‰ ì‹œê°„ì˜ ì°¨ì´ëŠ” 20ì´ˆë¡œ ë³€ê²½ëœë‹¤. PodëŠ” ì¢…ë£Œ ì „ preStop í›…ì„ ì‹¤í–‰í•œë‹¤. ë§Œì•½ preStop í›…ì´ terminationGracePeriodSecondsì˜ Default ê°’ì¸ 30ì´ˆ ë‚´ì— ìˆ˜í–‰ ë˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ContainerëŠ” ê°•ì œ ì¢…ë£Œëœë‹¤.  
ë”°ë¼ì„œ sleepì˜ ì‹œê°„ì„ 40ì´ˆë¡œ ë³€ê²½í•˜ì—¬ë„ terminationGracePeriodSeconds ì‹œê°„ 30ì´ˆê°€ ì§€ë‚˜ë©´ ê°•ì œ ì¢…ë£Œëœë‹¤. 

```bash
2023/04/04 07:03:24 [notice] 1#1: start worker process 36
2023/04/04 07:03:24 [notice] 1#1: start worker process 37
::1 - - [04/Apr/2023:07:03:28 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/7.74.0" "-"
2023/04/04 07:03:58 [notice] 1#1: signal 3 (SIGQUIT) received, shutting down
2023/04/04 07:03:58 [notice] 36#36: gracefully shutting down
2023/04/04 07:03:58 [notice] 36#36: exiting
2023/04/04 07:03:58 [notice] 36#36: exit
2023/04/04 07:03:58 [notice] 37#37: gracefully shutting down
2023/04/04 07:03:58 [notice] 37#37: exiting
2023/04/04 07:03:58 [notice] 37#37: exit
2023/04/04 07:03:58 [notice] 1#1: signal 17 (SIGCHLD) received from 37
2023/04/04 07:03:58 [notice] 1#1: worker process 36 exited with code 0
2023/04/04 07:03:58 [notice] 1#1: worker process 37 exited with code 0
2023/04/04 07:03:58 [notice] 1#1: exit
```
sleepì„ 40ì´ˆë¡œ ê±¸ì—ˆì„ ë•Œ ë¡œê·¸ë¥¼ í™•ì¸í•´ë³´ë©´ ë§ˆì§€ë§‰ `curl localhost`ê°€ í˜¸ì¶œë˜ì§€ ì•Šì•˜ìŒì„ ì•Œ ìˆ˜ ìˆë‹¤. preStop í›…ì´ ì™„ì „íˆ ì¢…ë£Œë˜ê¸° ì „ì— terminationGracePeriodSeconds ì‹œê°„ì— ì˜í•´ Containerê°€ ê°•ì œ ì¢…ë£Œë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

#### 3. Pod Lifetime

---

## ğŸ“š References

[1] **Kubernetes ê³µì‹ ë¬¸ì„œ**  
- https://kubernetes.io/docs/concepts/workloads/

[2] **ì°¸ê³  ë¬¸ì„œ**  
- https://learnk8s.io/graceful-shutdown

[3] **Kubernetes ê³µì‹ ë¬¸ì„œ**  
- https://kubernetes.io/docs/concepts/workloads/

[4] **ì°¸ê³  ë¬¸ì„œ**  
- https://learnk8s.io/graceful-shutdown
