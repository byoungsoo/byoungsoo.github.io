---
layout: post
title: "Kubernetes CoreDNS ì•Œì•„ë³´ê¸°"
author: "Bys"
category: k8s
date: 2023-06-27 01:00:00
tags: aws cloud eks coredns dns 
---

# [CoreDNS](https://coredns.io/)  
CoreDNSëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ì˜ DNS ì—­í• ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ”, ìœ ì—°í•˜ê³  í™•ì¥ ê°€ëŠ¥í•œ DNS ì„œë²„ì´ë‹¤.

CoreDNS is a DNS server.
CoreDNS integrates with Kubernetes via the Kubernetes plugin, or with etcd with the etcd plugin. All major cloud providers have plugins too

## 1. DNS Policy  
### [DNS Policy](https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy)
kubeletì€ spec.dnsPolicyë¥¼ í™•ì¸í•˜ì—¬ íŒŒë“œ ë‚´ /etc/resolv.conf ë‚´ìš©ì„ ì—…ë°ì´íŠ¸í•œë‹¤.  

íŒŒë“œì˜ Specì„ ì‚´í´ë³´ë©´ dnsPolicyì„¤ì •ì´ ì¡´ì¬í•œë‹¤. ì„¤ì •ëœ DNS Policy ì •ì±…ì— ë”°ë¼ ë™ì‘ë°©ì‹ì´ ë‹¤ë¥´ë¯€ë¡œ ê° íŠ¹ì§•ì„ ë¨¼ì € ì‚´í´ë³¸ë‹¤.  

- ClusterFirst  
  - DNS Policyì˜ Default ì„¤ì •ì´ë‹¤. Kubernetesì— ì¡´ì¬í•˜ëŠ” CoreDNSë¡œ DNS resolve ìš”ì²­ì„ í•˜ë©° ë§Œì•½ ì¼ì¹˜í•˜ëŠ” ë„ë©”ì¸ì´ ì—†ëŠ” ê²½ìš° upstream nameserverë¡œ ìš”ì²­ì„ ì „ë‹¬í•œë‹¤.  
    > Any DNS query that does not match the configured cluster domain suffix, such as "www.kubernetes.io", is forwarded to an upstream nameserver by the DNS server

- Default  
  - Default ì„¤ì •ì€ íŒŒë“œì˜ DNS resolve ì„¤ì •ì„ ë…¸ë“œë¡œ ë¶€í„° ìƒì† ë°›ëŠ” ë°©ë²•ì´ë‹¤.  
      > The Pod inherits the name resolution configuration from the node that the Pods run.  

- ClusterFirstWithHostNet  
  - hostNetworkì„¤ì •ì´ trueì¸ ê²½ìš° íŒŒë“œëŠ” ë…¸ë“œì˜ IPë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©° DNS ì •ì±…ì— ëª…ì‹œì ìœ¼ë¡œ ClusterFirstWithHostNet ì„¤ì •ì„ í•˜ì§€ ì•Šìœ¼ë©´ Default ì„¤ì •ê³¼ ê°™ì´ ë…¸ë“œë¡œ ë¶€í„° name resolution ì„¤ì •ì„ ìƒì† ë°›ëŠ”ë‹¤. ëª…ì‹œì ìœ¼ë¡œ ClusterFirstWithHostNet ì„¤ì •ì„ í•´ì•¼ì§€ë§Œ ClusterFirstì™€ ê°™ì€ ë™ì‘ì„ í•œë‹¤.  
    > For Pods running with hostNetwork, you should explicitly set its DNS policy to "ClusterFirstWithHostNet". Otherwise, Pods running with hostNetwork and "ClusterFirst" will fallback to the behavior of the "Default" policy.

- None  
  - DNS ì„¤ì •ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©° ëª¨ë“  DNS ì„¤ì •ì€ íŒŒë“œì˜ dnsConfig í•„ë“œì— ë³„ë„ë¡œ ì„¤ì •í•´ì£¼ì–´ì•¼ í•œë‹¤.  
  > It allows a Pod to ignore DNS settings from the Kubernetes environment. All DNS settings are supposed to be provided using the dnsConfig field in the Pod Spec.
    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
    namespace: default
    name: dns-example
    spec:
    containers:
        - name: test
        image: nginx
    dnsPolicy: "None"
    dnsConfig:
        nameservers:
        - 192.0.2.1 # this is an example
        searches:
        - ns1.svc.cluster-domain.example
        - my.dns.search.suffix
        options:
        - name: ndots
            value: "2"
        - name: edns0
    ```

<br><br>

## 2. ë™ì‘ë°©ì‹  

### ClusterFirst  

![coredns](/assets/it/cloud/eks/coredns.png){: width="70%" height="auto"}

Kubernetes í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤í–‰ ë˜ëŠ” íŒŒë“œëŠ” ë³„ë„ì˜ DNS ì •ì±…ì´ ì„¤ì •ë˜ì§€ ì•ŠëŠ” ê²½ìš° ClusterFirst ê°’ì´ ì„¤ì •ëœë‹¤. 
```bash
# kubectl get po netutil-7d85b6bbd9-5bfvq -o jsonpath='{"dnsPolicy:"}{"\t"}{.spec.dnsPolicy}{"\n"}'
dnsPolicy:	ClusterFirst
```

ì´ëŸ° ê²½ìš° ê° íŒŒë“œì˜ /etc/resolv.conf ì„¤ì • íŒŒì¼ì˜ nameserverëŠ” kube-dns ì„œë¹„ìŠ¤ì˜ ClusterIPì™€ ê°™ë‹¤.  
```bash
# kubectl exec -it netutil-7d85b6bbd9-5bfvq -- cat /etc/resolv.conf
search default.svc.cluster.local svc.cluster.local cluster.local ap-northeast-2.compute.internal
nameserver 172.20.0.10
options ndots:5
```
```bash
# kubectl get svc kube-dns -n kube-system -o wide
NAME       TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGE    SELECTOR
kube-dns   ClusterIP   172.20.0.10   <none>        53/UDP,53/TCP   248d   k8s-app=kube-dns
```

ì¦‰, íŒŒë“œëŠ” DNS Resolveë¥¼ ìœ„í•´ nameserverì¸ 172.20.0.10ë¡œ ìš”ì²­ì„ í•˜ê²Œ ë˜ë©° 172.20.0.10 IPëŠ” kube-dns ì„œë¹„ìŠ¤ë‹¤.  
ì´ ë•Œ search ì„¤ì •ì— ë”°ë¼ ìˆœì„œëŒ€ë¡œ namespace.svc.cluster.localì„ ì°¾ê²Œ ëœë‹¤.  

ë‹¤ì‹œ kube-dns ì„œë¹„ìŠ¤ëŠ” Selectorë¡œ 'k8s-app=kube-dns' ê°’ì„ ê°€ì§€ê³  ìˆìœ¼ë©° CoreDNS íŒŒë“œì˜ IPë¥¼ Endpointsë¡œ ê°–ëŠ”ë‹¤.  
```bash
# kubectl describe svc kube-dns -n kube-system
Name:              kube-dns
Namespace:         kube-system
Labels:            eks.amazonaws.com/component=kube-dns
                   k8s-app=kube-dns
                   kubernetes.io/cluster-service=true
                   kubernetes.io/name=CoreDNS
Annotations:       prometheus.io/port: 9153
                   prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                172.20.0.10
IPs:               172.20.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         10.20.10.149:53,10.20.10.84:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         10.20.10.149:53,10.20.10.84:53
Session Affinity:  None
Events:            <none>


# kubectl get po -n kube-system -o wide | grep -i coredns
coredns-6b78c9b97-mtqnc                        1/1     Running   0          4d20h   10.20.10.149   ip-10-20-10-226.ap-northeast-2.compute.internal   <none>           <none>
coredns-6b78c9b97-r7r5m                        1/1     Running   0          4d20h   10.20.10.84    ip-10-20-10-207.ap-northeast-2.compute.internal   <none>           <none>
```

EKSì—ì„œ CoreDNS íŒŒë“œì˜ /etc/resolv.conf ëŠ” VPC DNS ì„œë²„ë¡œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©° ë§Œì•½ resolveë¥¼ í•  ìˆ˜ ì—†ëŠ” ë„ë©”ì¸ì˜ ê²½ìš°ëŠ” Upstream ì„œë²„ë¡œ ìš”ì²­ë˜ì–´ resolveê°€ ëœë‹¤.  

<br>

### Default  
íŒŒë“œì˜ dnsPolicyë¥¼ Defaultë¡œ ì„¤ì •í•œ í›„ ë°°í¬í•œë‹¤.  
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox-default
spec:
  containers:
  - image: busybox:1.28
    command:
      - sleep
      - "7200"
    imagePullPolicy: IfNotPresent
    name: busybox
  dnsPolicy: "Default"
  restartPolicy: Always
```

Default ì •ì±…ì„ ê°€ì§„ íŒŒë“œì˜ /etc/resolv.conf ë¥¼ ì‚´í´ë³´ë©´ ClusterFirstì™€ëŠ” ë‹¤ë¥´ê²Œ nameserverê°€ 10.20.0.2ë¡œ AWS VPCì—ì„œ ì œê³µí•˜ëŠ” DNSì„œë²„ë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  
```bash
# kubectl exec -it busybox-default -- cat /etc/resolv.conf
search ap-northeast-2.compute.internal
nameserver 10.20.0.2
options timeout:2 attempts:5
```

ë”°ë¼ì„œ EKS í´ëŸ¬ìŠ¤í„°ë‚´ ë„ë©”ì¸ì— ëŒ€í•´ì„œëŠ” DNS ë¦¬ì¡¸ë¸Œê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤. 
```bash
# kubectl exec -it busybox-default -- nslookup kubernetes
Server:    10.20.0.2
Address 1: 10.20.0.2 ip-10-20-0-2.ap-northeast-2.compute.internal

nslookup: can't resolve 'kubernetes'
command terminated with exit code 1
```

í•˜ì§€ë§Œ ì™¸ë¶€ì— ë“±ë¡ëœ DNSì˜ ê²½ìš° ë¦¬ì¡¸ë¸Œê°€ ê°€ëŠ¥í•˜ë‹¤.  
```bash
# kubectl exec -it busybox-default -- nslookup www.amazon.com
Server:    10.20.0.2
Address 1: 10.20.0.2 ip-10-20-0-2.ap-northeast-2.compute.internal

Name:      www.amazon.com
Address 1: 2600:9000:2139:4800:7:49a5:5fd2:8621
Address 2: 2600:9000:2139:5600:7:49a5:5fd2:8621
Address 3: 2600:9000:2139:7000:7:49a5:5fd2:8621
Address 4: 2600:9000:2139:9e00:7:49a5:5fd2:8621
Address 5: 2600:9000:2139:ac00:7:49a5:5fd2:8621
Address 6: 2600:9000:2139:b800:7:49a5:5fd2:8621
Address 7: 2600:9000:2139:7c00:7:49a5:5fd2:8621
Address 8: 2600:9000:2139:3c00:7:49a5:5fd2:8621
Address 9: 99.86.147.122 server-99-86-147-122.icn51.r.cloudfront.net
```

<br>

### ClusterFirstWithHostNet
ë¨¼ì € hostNetworkì´ trueì¸ ì„¤ì •ì˜ íŒŒë“œë¥¼ ì‚´í´ë³¸ë‹¤.  
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox-clusterfirstwithhostnet
spec:
  containers:
  - image: busybox:1.28
    command:
      - sleep
      - "7200"
    imagePullPolicy: IfNotPresent
    name: busybox
  hostNetwork: true
  restartPolicy: Always
```

hostNetworkì´ trueì¸ ê²½ìš° íŒŒë“œì˜ IPëŠ” ë…¸ë“œì™€ ê°™ì€ IPë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.  ì´ ë•Œ /etc/resolv.conf ë˜í•œ ë…¸ë“œì˜ DNS ì„¤ì •ì„ ìƒì†ë°›ëŠ”ë‹¤.  
```bash
# kubectl get po busybox-clusterfirstwithhostnet -o wide
NAME                              READY   STATUS    RESTARTS   AGE   IP             NODE                                              NOMINATED NODE   READINESS GATES
busybox-clusterfirstwithhostnet   1/1     Running   0          54s   10.20.11.149   ip-10-20-11-149.ap-northeast-2.compute.internal   <none>           <none>


# kubectl exec -it busybox-clusterfirstwithhostnet -- cat /etc/resolv.conf
search ap-northeast-2.compute.internal
nameserver 10.20.0.2
options timeout:2 attempts:5
```

ë”°ë¼ì„œ hostNetworkì´ trueë¡œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ì„œ ClusterFirst ì •ì±…ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” dnsPolicyë¥¼ ClusterFirstWithHostNetë¡œ ëª…ì‹œì  ì§€ì •ì„ í•´ì£¼ì–´ì•¼ í•œë‹¤.  
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox-clusterfirstwithhostnet
spec:
  containers:
  - image: busybox:1.28
    command:
      - sleep
      - "7200"
    imagePullPolicy: IfNotPresent
    name: busybox
  hostNetwork: true
  dnsPolicy: "ClusterFirstWithHostNet"
  restartPolicy: Always
```

ìœ„ ì™€ ê°™ì´ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •ëœ ê²½ìš° CoreDNSë¥¼ nameserverë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.  
```
# kubectl exec -it busybox-clusterfirstwithhostnet -- cat /etc/resolv.conf
search default.svc.cluster.local svc.cluster.local cluster.local ap-northeast-2.compute.internal
nameserver 172.20.0.10
options ndots:5
```

<br><br>

## 3. [CoreDNS Config]()  
CoreDNSëŠ” ì„¤ì • íŒŒì¼ì„ í†µí•´ ì–´ë–¤ í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í• ì§€ì™€ ìš”ì²­ì„ ì–´ë–»ê²Œ ì²˜ë¦¬í•´ì•¼ í• ì§€ ë“± ë™ì‘ì— ëŒ€í•´ ì •ì˜ ë˜ì–´ìˆë‹¤.  

ì´ ì„¤ì • íŒŒì¼ì€ coredns ì´ë¦„ìœ¼ë¡œ ìƒì„±ëœ ConfigMapìœ¼ë¡œ ì •ì˜ ë˜ì–´ ìˆë‹¤.  

```yaml
# kubectl get cm coredns -n kube-system -o yaml
apiVersion: v1
data:
  Corefile: |
    .:53 {
        errors
        log
        health
        kubernetes cluster.local in-addr.arpa ip6.arpa {
          pods insecure
          fallthrough in-addr.arpa ip6.arpa
        }
        prometheus :9153
        forward . /etc/resolv.conf
        cache 30
        loop
        reload
        loadbalance
    }
kind: ConfigMap
metadata:
  labels:
    eks.amazonaws.com/component: coredns
    k8s-app: kube-dns
  name: coredns
  namespace: kube-system
```

- `.:53`ì„ í†µí•´ ëª¨ë“  ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ 53 í¬íŠ¸ë¥¼ Listening í•˜ê³  ìˆëŠ” í•˜ë‚˜ì˜ ì„œë²„ì— ëŒ€í•œ ì„¤ì •ì´ ì¡´ì¬í•œë‹¤. .:port-num
- `errors`, `log`, `health`, `kubernetes` ë“±ì˜ í”ŒëŸ¬ê·¸ì¸ ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  
  - `log`ì˜ ê²½ìš° ìš”ì²­ì— ëŒ€í•œ ë¡œê·¸ë¥¼ í™œì„±í™” í•˜ê¸° ìœ„í•´ì„œ ì‚¬ìš©í•œë‹¤.  
  - `errors`ì˜ ê²½ìš° ìš”ì²­ì— ëŒ€í•œ ì˜¤ë¥˜ë“¤ì„ ë¡œê¹…í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤.  
  - `kubernetes`ì˜ ê²½ìš° cluster.local ê³¼ ê°™ì€ ë„ë©”ì¸ì— ëŒ€í•œ ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©í•œë‹¤.  
  - `forward`ì˜ ê²½ìš° kubernetes cluster domainì—ì„œ ì¡°íšŒë˜ì§€ ì•ŠëŠ” ìš”ì²­ë“¤ì€ /etc/resolv.conf ì— ì‚¬ì „ ì •ì˜ëœ resolverë¡œ ì „ë‹¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤.  
  - `cache`ì˜ ê²½ìš° ìºì‰¬ ì‹œê°„ì„ ì„¤ì •í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤.  
  - `autopath`ì˜ ê²½ìš° ì¿¼ë¦¬ latencyë¥¼ ì¤„ì´ê¸° ìœ„í•´ ì„œë²„ì¸¡ì—ì„œ searchë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤.  


## 10. Trouble Shooting
##### 1. CoreDNSë¥¼ ì´ìš©í•˜ëŠ” íŒŒë“œëŠ” CoreDNSíŒŒë“œì˜ ë³´ì•ˆê·¸ë£¹ì— 53ë²ˆ TCP/UDP í¬íŠ¸ê°€ í—ˆìš©ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤.  
   - Connection ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ê²½ìš° dnsutil íŒŒë“œ ë“±ì„ ìƒì„±í•˜ì—¬ ê° CoreDNS íŒŒë“œë¡œì˜ ping, telnet ë“±ì„ í†µí•´ ì»¨ë„¥ì…˜ì„ í™•ì¸í•œë‹¤.  
    ```bash
    ;; connection timed out; no servers could be reached
    ```


##### 2. [CoreDNSì˜ ë¦¬ì†ŒìŠ¤ ì„¤ì •](https://github.com/coredns/deployment/blob/master/kubernetes/Scaling_CoreDNS.md)
   - To estimate the amount of memory required for a CoreDNS instance (using default settings), you can use the following formula:
     > MB required (default settings) = (Pods + Services) / 1000 + 54
   - Monitoring íˆ´ ë“±ì„ í†µí•´ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ì„ ëª¨ë‹ˆí„°ë§ í•´ì•¼ í•œë‹¤.  


##### 3. EKS CoreDNSë¥¼ ì‚¬ìš©í•  ë•Œ [Throttling](https://aws.amazon.com/ko/blogs/mt/monitoring-coredns-for-dns-throttling-issues-using-aws-open-source-monitoring-services/)  
    - Hard limit of 1024 packets per second (PPS) set at the ENI level.
    - ìš”ì²­ì´ ë§ì€ ê²½ìš° CoreDNSì˜ íŒŒë“œ ìˆ˜ë¥¼ ëŠ˜ë¦¬ë©° ë…¸ë“œ ë¶„ì‚°ì„ ì‹œì¼œì•¼ í•œë‹¤. 


##### 4. ê°„í—ì ì¸ DNS Query ì‹¤íŒ¨
    - íŒ¨í‚· ì „ì†¡ì— ëŒ€í•œ í™•ì¸. [ENA(bw_in_allowance_exceeded, bw_out_allowance_exceeded)ì§€í‘œ](https://docs.aws.amazon.com/ko_kr/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-network-performance.html) í™•ì¸
      ```bash
      ## i-aaa
      Interface eth0
          bw_in_allowance_exceeded: 1978
          bw_out_allowance_exceeded: 4653
      Interface eth1
          bw_in_allowance_exceeded: 1929579
          bw_out_allowance_exceeded: 16206642

      ## i-bbb
      Interface eth0
          bw_in_allowance_exceeded: 116227
          bw_out_allowance_exceeded: 60238163
      Interface eth1
          bw_in_allowance_exceeded: 0
          bw_out_allowance_exceeded: 2

      ## i-ccc
      Interface eth0
          bw_in_allowance_exceeded: 608068
          bw_out_allowance_exceeded: 1787157
      Interface eth1
          bw_in_allowance_exceeded: 0
          bw_out_allowance_exceeded: 399
      ```
        - bw_in_allowance_exceeded: ì¸ë°”ìš´ë“œ ì§‘ê³„ ëŒ€ì—­í­ì´ ì¸ìŠ¤í„´ìŠ¤ì˜ ìµœëŒ“ê°’ì„ ì´ˆê³¼í•˜ì—¬ ëŒ€ê¸°ì—´ì— ìˆê±°ë‚˜ ì‚­ì œëœ íŒ¨í‚· ìˆ˜
          > The number of packets queued or dropped because the inbound aggregate bandwidth exceeded the maximum for the instance.
   
        - bw_out_allowance_exceeded: ì•„ì›ƒë°”ìš´ë“œ ì§‘ê³„ ëŒ€ì—­í­ì´ ì¸ìŠ¤í„´ìŠ¤ì˜ ìµœëŒ“ê°’ì„ ì´ˆê³¼í•˜ì—¬ ëŒ€ê¸°ì—´ì— ìˆê±°ë‚˜ ì‚­ì œëœ íŒ¨í‚· ìˆ˜
          > The number of packets queued or dropped because the outbound aggregate bandwidth exceeded the maximum for the instance.


##### 5. ndots ì´ë€?
  ```
  search default.svc.cluster.local svc.cluster.local cluster.local dns.podman
  nameserver 10.96.0.10
  options ndots:5
  ```
  If your requested domain name donâ€™t have 5 dots in there, pod will append default.svc.cluster.local, svc.cluster.local, cluster.local and dns.podman with your requested domain name and send request one by one to core-dns


---

## ğŸ“š References

[1] **GitHub  CoreDNS**  
- [1] https://github.com/coredns/coredns

