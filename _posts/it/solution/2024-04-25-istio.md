---
layout: post
title: "Istio Service Mesh"
author: "Bys"
category: solution
date: 2024-04-25 01:00:00
tags: istio servicemesh
---

## Istio

### 1. Istio service mesh
#### [Istio Architecture](https://istio.io/latest/docs/ops/deployment/architecture/)
IstioëŠ” ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ê³¼ ë°ì´í„° í”Œë ˆì¸ìœ¼ë¡œ ë‚˜ë‰œë‹¤.  
- ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ì€ íŠ¸ë˜í”½ ë¼ìš°íŒ…ì„ ìœ„í•´ í”„ë¡ì‹œë¥¼ ê´€ë¦¬í•˜ê³  êµ¬ì„±í•˜ëŠ” ì—­í• ì„ ë‹´ë‹¹í•œë‹¤.   
- ë°ì´í„° í”Œë ˆì¸ì€ ì‚¬ì´ë“œì¹´ë¡œ ë°°í¬ëœ ì¼ë ¨ì˜ ì§€ëŠ¥í˜• í”„ë¡ì‹œ(Envoy)ë¡œ êµ¬ì„±ë˜ë©° ì´ëŸ¬í•œ í”„ë¡ì‹œëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ì˜ ëª¨ë“  ë„¤íŠ¸ì›Œí¬ í†µì‹ ì„ ì¤‘ê°œí•˜ê³  ì œì–´í•œë‹¤. ë˜í•œ ëª¨ë“  ë©”ì‹œ íŠ¸ë˜í”½ì— ëŒ€í•´ í…”ë ˆë©”íŠ¸ë¦¬ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ë³´ê³ í•œë‹¤.  

![istio-architecture001.png](/assets/it/cloud/eks/service-mesh/istio-architecture001.png){: width="70%" height="auto"}  


#### [Istio Component](https://istio.io/latest/docs/ops/deployment/architecture/#components)
- Envoy  
IstioëŠ” `Envoy` í”„ë¡ì‹œë¥¼ ì´ìš©í•©ë‹ˆë‹¤. EnvoyëŠ” ì„œë¹„ìŠ¤ ë©”ì‹œì˜ ëª¨ë“  ì„œë¹„ìŠ¤ì— ëŒ€í•œ ëª¨ë“  Inbound/Outbound íŠ¸ë˜í”½ì— ëŒ€í•´ ì¤‘ê°œí•˜ëŠ” ê³ ì„±ëŠ¥ Proxy ì…ë‹ˆë‹¤. Envoy í”„ë¡ì‹œëŠ” ë°ì´í„° í”Œë ˆì¸ íŠ¸ë˜í”½ê³¼ ìƒí˜¸ì‘ìš©í•˜ëŠ” ìœ ì¼í•œ Istio ì»´í¬ë„ŒíŠ¸ì´ë‹¤.  
Envoy í”„ë¡ì‹œëŠ” ì‚¬ì´ë“œì¹´ íŒ¨í„´ìœ¼ë¡œ ë°°í¬ë˜ë©° ë…¼ë¦¬ì ìœ¼ë¡œ Envoyì˜ ì•„ë˜ì˜ ë‹¤ì–‘í•œ build-in ê¸°ëŠ¥ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ë…¼ë¦¬ì ìœ¼ë¡œ ë³´ê°•í•œë‹¤.  
  - Dynamic service discovery
  - Load balancing
  - TLS termination
  - HTTP/2 and gRPC proxies
  - Circuit breakers
  - Health checks
  - Staged rollouts with %-based traffic split
  - Fault injection
  - Rich metrics

  Envoy í”„ë¡ì‹œì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” Istio ê¸°ëŠ¥ ë° ì‘ì—…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.  
    - íŠ¸ë˜í”½ ì œì–´ ê¸°ëŠ¥: HTTP, gRPC, WebSocket, TCP íŠ¸ë˜í”½ ì— ëŒ€í•´ì„œ ë‹¤ì–‘í•œ ë¼ìš°íŒ… ê·œì¹™ì„ í†µí•´ ì„¸ë¶„í™”ëœ íŠ¸ë˜í”½ ì œì–´ ì‹œí–‰
    - ë„¤íŠ¸ì›Œí¬ ë³µì›ë ¥ ê¸°ëŠ¥: Setup retries, Fail-over, Circuit breakers,  Fault injection
    - ë³´ì•ˆ ë° ì¸ì¦ ê¸°ëŠ¥: ë³´ì•ˆ ì •ì±…, ì ‘ê·¼ ì œì–´, ì†ë„ ì œí•œì„ ì‹œí–‰


- Istiod  
Istiod provides service discovery, configuration and certificate management. 

  `Istiod`ëŠ” íŠ¸ë˜í”½ ë™ì‘ì„ ì œì–´í•˜ëŠ” high level ë¼ìš°íŒ… ê·œì¹™ì„ Envoy ì „ìš© êµ¬ì„±ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ëŸ°íƒ€ì„ì— ì‚¬ì´ë“œì¹´ì— ì „íŒŒí•œë‹¤. `Pilot` í”Œë«í¼ë³„ ì„œë¹„ìŠ¤ ê²€ìƒ‰ ë©”ì»¤ë‹ˆì¦˜ì„ ì¶”ìƒí™”í•˜ì—¬ Envoy APIë¥¼ ì¤€ìˆ˜í•˜ëŠ” ëª¨ë“  ì‚¬ì´ë“œì¹´ê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í‘œì¤€í˜•ì‹ìœ¼ë¡œ í•©ì„±í•œë‹¤.  
  Istiod ë³´ì•ˆì€ build-in identity ë° ìê²© ì¦ëª… ê´€ë¦¬ë¥¼ í†µí•´ ê°•ë ¥í•œ ì„œë¹„ìŠ¤ ê°„ ë° ìµœì¢… ì‚¬ìš©ì ì¸ì¦ì„ ì§€ì›í•©ë‹ˆë‹¤. Istioë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ ë©”ì‹œì—ì„œ ì•”í˜¸í™”ë˜ì§€ ì•Šì€ íŠ¸ë˜í”½ì„ ì—…ê·¸ë ˆì´ë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìš´ì˜ìëŠ” Istioë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒëŒ€ì ìœ¼ë¡œ ë¶ˆì•ˆì •í•œ ê³„ì¸µ 3 ë˜ëŠ” ê³„ì¸µ 4 ë„¤íŠ¸ì›Œí¬ ì‹ë³„ì ëŒ€ì‹  ì„œë¹„ìŠ¤ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •ì±…ì„ ì‹œí–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ Istioì˜ ì¸ê°€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ìë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. IstiodëŠ” ì¸ì¦ ê¸°ê´€(CA) ì—­í• ì„ í•  ìˆ˜ ìˆìœ¼ë©° ë°ì´í„° í”Œë ˆì¸ì—ì„œ ì•ˆì „í•œ mTLS í†µì‹ ì„ í—ˆìš©í•˜ëŠ” ì¸ì¦ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

<br>

### 2. [Install Istio](https://istio.io/latest/docs/setup/getting-started/)  
Istioë¥¼ ì„¤ì¹˜í•˜ëŠ” ë°©ë²•ì—ëŠ” ì—¬ëŸ¬ê°€ì§€ ë°©ë²•ì´ ìˆê³  istioctlê³¼ helmì„ í†µí•œ ì„¤ì¹˜ë°©ë²•ì„ ì†Œê°œí•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” Helmì„ ì´ìš©í•˜ê¸°ë¡œ í•œë‹¤. Helmì˜ valuesíŒŒì¼ì„ ë³€ê²½í•˜ì—¬ í•„ìš”í•œ ê°’ì„ Customizeí•˜ì—¬ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œë‹¤.  

#### 2.1. Install with istioctl
`Install Download`
```bash
curl -L https://istio.io/downloadIstio | sh -
cd istio-1.19.3
cp bin/istioctl /usr/local/bin
```

`Install`  
```bash
istioctl install --set profile=demo -y
istioctl uninstall --set profile=demo -y
```

`Injection Configuration`  
```bash
kubectl label namespace default istio-injection=enabled
```

`Deploy the sample application`
```bash
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
```
<br>

#### 2.2. Install with helm
[base-values.yaml](https://github.com/istio/istio/blob/master/manifests/charts/base/values.yaml)  
[istiod-values.yaml](https://github.com/istio/istio/blob/master/manifests/charts/istio-control/istio-discovery/values.yaml)  
[gateway-values.yaml](https://github.com/istio/istio/blob/master/manifests/charts/gateway/values.yaml)  


`gateway-values.yaml`  
ingress-gatewayë¥¼ ìœ„í•´ 
1. Service(NLB)ì˜ ì„¤ì •íŒŒì¼ ì‹¤ì œ Listenerë¡œ ì„¤ì •ë  í¬íŠ¸ëŠ” ì„œë¹„ìŠ¤ í¬íŠ¸ì´ë©° íƒ€ê²Ÿ í¬íŠ¸ë¡œ ì„¤ì •ë  í¬íŠ¸ëŠ” Gateway ì„œë²„í¬íŠ¸ì™€ ì¼ì¹˜í•´ì•¼ í•œë‹¤. 
2. í—¬ìŠ¤ì²´í¬ì— ëŒ€í•´ì„œëŠ” ê³ ë¯¼ì´ í•„ìš”í•˜ë‹¤. 15021 í¬íŠ¸ë¡œ í—¬ìŠ¤ì²´í¬ë¥¼ í•˜ë©´ istio-ingressgateway íŒŒë“œ ìì²´ì— ëŒ€í•œ í—¬ìŠ¤ì²´í¬ëŠ” ê°€ëŠ¥í•˜ë‚˜ backend ì„œë¹„ìŠ¤ì— ìì²´ì— ëŒ€í•œ í—¬ìŠ¤ì²´í¬ëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤. ë§Œì•½ traffic-portë¡œ ë³€ê²½í•  ê²½ìš° healthcheck-path ê°’ì„ í†µí•´ backend ì¤‘ í•˜ë‚˜ì—ëŠ” íŠ¸ë˜í”½ì„ ë³´ë‚¼ ìˆ˜ ìˆì§€ë§Œ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ë¡œëŠ” ë³´ë‚¼ ìˆ˜ ì—†ë‹¤. ê·¸ë˜ì„œ traffic-portë¥¼ tcpë¡œ ë³€ê²½í•˜ê³  traffic-portë¡œ ì„¤ì •í•˜ë©´ ê° ì„œë¹„ìŠ¤ì— ëŒ€í•œ í—¬ìŠ¤ì²´í¬ê°€ ê°€ëŠ¥í•˜ë‹¤(pathëŠ” ì œì™¸í•˜ì˜€ì§€ë§Œ).   

```yaml
service:
  # Type of service. Set to "None" to disable the service entirely
  type: LoadBalancer
  ports:
  # - name: status-port
  #   port: 15021
  #   protocol: TCP
  #   targetPort: 15021
  # - name: https
  #   port: 443
  #   protocol: TCP
  #   targetPort: 10012
  # ì‹¤ì œ íŠ¸ë˜í”½ ì „ë‹¬ì„ ìœ„í•´ ì‚¬ìš© í•˜ëŠ” í¬íŠ¸ (awssdk)
  - name: https
    port: 443
    protocol: TCP
    targetPort: 80
  # ì‹¤ì œ íŠ¸ë˜í”½ ì „ë‹¬ì„ ìœ„í•´ ì‚¬ìš© í•˜ëŠ” í¬íŠ¸ (bookinfo)
  - name: http
    port: 8080
    protocol: TCP
    targetPort: 8080
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-name: k8s-istiosys-ingressgateway
    service.beta.kubernetes.io/aws-load-balancer-type: external
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
    service.beta.kubernetes.io/aws-load-balancer-subnets: subnet-02e6d788fad8afdcf, subnet-020255d69e8c814da #az1-extelb, az3-extelb
    service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
    service.beta.kubernetes.io/aws-load-balancer-attributes: load_balancing.cross_zone.enabled=true
    service.beta.kubernetes.io/aws-load-balancer-ssl-negotiation-policy: ELBSecurityPolicy-TLS13-1-2-2021-06
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: arn:aws:acm:ap-northeast-2:558846430793:certificate/250015a4-4753-4a97-b536-88a6e6aaaf73
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: tcp
    
    # SET 1
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: http
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "15021"  # traffic-port "15021"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: /healthz/ready
    # SET 2
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: tcp
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: traffic-port  # traffic-port "15021"

    service.beta.kubernetes.io/aws-load-balancer-healthcheck-healthy-threshold: "2"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-unhealthy-threshold: "3"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval: "20"
    service.beta.kubernetes.io/aws-load-balancer-security-groups: sg-0f94ae1a6d9ba9d69
    service.beta.kubernetes.io/aws-load-balancer-additional-resource-tags: auto-delete=no
  loadBalancerIP: ""
  loadBalancerSourceRanges: []
  externalTrafficPolicy: ""
  externalIPs: []
  ipFamilyPolicy: ""
  ipFamilies: []
```

ì„¤ì •í•œ íŒŒì¼ì„ ê°€ì§€ê³  ì´ 3ê°œì˜ Helm ì°¨íŠ¸ë¥¼ ì„¤ì¹˜í•œë‹¤. 
1. istio-base
   - CRD, WebhookConfiguration ë“±ì´ ì„¤ì¹˜ëœë‹¤.  
2. istiod
3. istio-ingressgateway

```bash
helm repo add istio https://istio-release.storage.googleapis.com/charts
helm repo update
kubectl create namespace istio-system

helm upgrade -i istio-base istio/base -n istio-system -f /Users/bys/workspace/kubernetes/istio/bys-dev-eks-main/helm/base-values.yaml
helm upgrade -i istiod istio/istiod -n istio-system -f /Users/bys/workspace/kubernetes/istio/bys-dev-eks-main/helm/istiod-values.yaml
helm upgrade -i istio-ingressgateway istio/gateway -n istio-system -f /Users/bys/workspace/kubernetes/istio/bys-dev-eks-main/helm/gateway-values.yaml
```
<br>


#### 2.2. [Istio object](https://istio.io/latest/docs/reference/config/networking/)
- [Gateway](https://istio.io/latest/docs/reference/config/networking/gateway/)  
GatewayëŠ” ì†¡/ìˆ˜ì‹  HTTP/TCP ì—°ê²°ì„ ë°›ëŠ” ì„œë¹„ìŠ¤ ë©”ì‹œì˜ edgeì—ì„œ ë™ì‘í•˜ëŠ” ë¡œë“œë°¸ëŸ°ì„œë¥¼ ì„¤ëª…í•œë‹¤. ì¦‰, ë…¸ì¶œí•´ì•¼í•˜ëŠ” port, protocol, ë¡œë“œë°¸ëŸ°ì„œì— ëŒ€í•œ SNI êµ¬ì„±ì„ ì„¤ì •í•œë‹¤. ì•„ë˜ì˜ Gateway ëª…ì„¸ëŠ” ë¡œë“œë°¸ëŸ°ì„œì˜ L4-L6 ì†ì„±ì„ ì„¤ëª…í•œë‹¤.  
(Gatewayì˜ í¬íŠ¸ ì„¤ì •ì€ istio-ingressgatewayë¡œ ë°°í¬ëœ proxy ì„œë²„ì˜ íƒ€ê²Ÿí¬íŠ¸ì™€ ì¼ì¹˜í•´ì•¼í•˜ëŠ”ë°, ê·¸ íƒ€ê²Ÿí¬íŠ¸ë¡œ ë„ í–ˆì„ ë•Œì˜ Gateway ë§µí•‘ìœ¼ë¡œ ì´í•´í•˜ë©´ ì´í›„ ë¼ìš°íŒ… ë™ì‘ì€ Gatewayì™€ ì—°ê²°ëœ VirtualServiceì—ì„œ ì •ì˜í•œë‹¤ê³  ì´í•´í•˜ë©´ ëœë‹¤)

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: my-gateway
  namespace: some-config-namespace
spec:
  selector:
    app: my-gateway-controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - uk.bookinfo.com
    - eu.bookinfo.com
    tls:
      httpsRedirect: true # sends 301 redirect for http requests
  - port:
      number: 443
      name: https-443
      protocol: HTTPS
    hosts:
    - uk.bookinfo.com
    - eu.bookinfo.com
    tls:
      mode: SIMPLE # enables HTTPS on this port
      serverCertificate: /etc/certs/servercert.pem
      privateKey: /etc/certs/privatekey.pem
  - port:
      number: 9443
      name: https-9443
      protocol: HTTPS
    hosts:
    - "bookinfo-namespace/*.bookinfo.com"
    tls:
      mode: SIMPLE # enables HTTPS on this port
      credentialName: bookinfo-secret # fetches certs from Kubernetes secret
  - port:
      number: 9080
      name: http-wildcard
      protocol: HTTP
    hosts:
    - "*"
  - port:
      number: 2379 # to expose internal service via external port 2379
      name: mongo
      protocol: MONGO
    hosts:
    - "*"
```


- [VirtualService](https://istio.io/latest/docs/reference/config/networking/virtual-service/#VirtualService)  
íŠ¸ë˜í”½ ë¼ìš°íŒ…ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ì„¤ì •ì´ë‹¤. VirtualServiceëŠ” hostë¥¼ í†µí•´ ëª©ì ì§€ ì£¼ì†Œë¥¼ ì§€ì •í•˜ë©° íŠ¸ë˜í”½ ë¼ìš°íŒ… ì§‘í•©ì„ ì •ì˜í•œë‹¤. route.destination.subsetì€ DestinationRuleì— ì„ ì–¸ëœ ì„œë¹„ìŠ¤ subsetì˜ ì´ë¦„ì„ ì°¸ì¡°í•˜ì—¬ ì‹ë³„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. 

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-route
spec:
  hosts:
  - reviews.prod.svc.cluster.local
  http:
  - name: "reviews-v2-routes"
    match:
    - uri:
        prefix: "/wpcatalog"
    - uri:
        prefix: "/consumercatalog"
    rewrite:
      uri: "/newcatalog"
    route:
    - destination:
        host: reviews.prod.svc.cluster.local
        subset: v2
  - name: "reviews-v1-route"
    route:
    - destination:
        host: reviews.prod.svc.cluster.local
        subset: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews-destination
spec:
  host: reviews.prod.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

ì´ ì™¸ì—ë„ [ê¸°íƒ€ ì—¬ëŸ¬ ì„¤ì •](https://istio.io/latest/docs/tasks/traffic-management/) ë“±ì„ í†µí•´ ì¶”ê°€ì ì¸ Traffic ì œì–´ê°€ ê°€ëŠ¥í•˜ë‹¤.  


<br>

#### 2.3. [Kiali dashbaord](https://istio.io/latest/docs/tasks/observability/kiali/)
Istio ë©”ì‹œì˜ ì‹œê°í™”ë¥¼ ìœ„í•´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì¶”í›„ Sampleì„ ë°°í¬í•˜ê³  íë¦„ì„ ë³¼ ìˆ˜ ìˆë„ë¡ ë¯¸ë¦¬ ì„¤ì¹˜ë¥¼ ì§„í–‰í•œë‹¤.  

[Install Kiali](https://istio.io/latest/docs/ops/integrations/kiali/)
```bash
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.21/samples/addons/kiali.yaml

istioctl dashboard kiali
```
<br>

#### 2.4 Deploy Sample Application
```bash
kubectl label namespace default istio-injection=enabled

## Deploy sample Deployments, Services 
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml

## Deploy sample Gateway, VirtualService
kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
```

ì •ìƒì ìœ¼ë¡œ ë°°í¬ê°€ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ ì‘ì—…  
```bash
export INGRESS_NAME=istio-ingressgateway
export INGRESS_NS=istio-system

kubectl get svc "$INGRESS_NAME" -n "$INGRESS_NS"

export INGRESS_HOST=$(kubectl -n "$INGRESS_NS" get service "$INGRESS_NAME" -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
export INGRESS_PORT=$(kubectl -n "$INGRESS_NS" get service "$INGRESS_NAME" -o jsonpath='{.spec.ports[?(@.name=="http")].port}')

export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT

curl http://$GATEWAY_URL/productpage
# watch -n 1 curl -o /dev/null -s -w %{http_code} $GATEWAY_URL/productpage
```

<br>
 
#### 2.5 Deploy Application(ê°œì¸ìš©)
ê¸°ì¡´ì˜ ì¡´ì¬í•˜ë˜ Applicationì— Gateway, VirtualService ì¶”ê°€ êµ¬ì„±.

`awssdk-gateway`  
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: awssdk-gateway
  namespace: aws
spec:
  # The selector matches the ingress gateway pod labels.
  # If you installed Istio using Helm following the standard documentation, this would be "istio=ingress"
  selector:
    # istio: ingressgateway # use istio default controller
    istio: ingressgateway # use istio default controller
  servers:
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - "istio-awssdk.bys.asia"
```

`awssdk-virtual-service`  
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: awssdk-virtual-service
  namespace: aws
spec:
  hosts:
    - "*"
  gateways:
    - awssdk-gateway
  http:
    - match:
        - uri:
            prefix: /storage
      route:
        - destination:
            host: awssdk-storage-dev-svc.aws.svc.cluster.local
            port:
              number: 10011
    - match:
        - uri:
            prefix: /iam
      route:
        - destination:
            host: awssdk-iam-dev-svc.aws.svc.cluster.local
            port:
              number: 10012
```

```bash
curl -v https://istio-awssdk.bys.asia/storage/v2/s3/buckets
curl -v https://istio-awssdk.bys.asia/iam/v2/sts/id
```


<br><br>

### 10. Troubleshooting 
##### 1. Kiali êµ¬ì„± ì‹œ, ê¸°ì¡´ Prometheus ì—°ê²°  
Kiali dashboardë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” prometheus êµ¬ì„±ì´ í•„ìˆ˜ì´ì§€ë§Œ ê¸°ì¡´ prometheusê°€ ì„¤ì¹˜ëœ ê²½ìš° istio-systemì— ì¡´ì¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì£¼ì†Œë¥¼ ë“±ë¡í•´ì£¼ì–´ì•¼ í•œë‹¤.  
kiali ConfigMapì˜ external_servicesì— custom ì„¤ì¹˜ëœ prometheus URLì„ ì¶”ê°€í•˜ì—¬ ì„¤ì •í•œë‹¤.  
```yaml
# kubectl edit cm kiali -n istio-system

......
      external_services:
        custom_dashboards:
          enabled: true
        istio:
          root_namespace: istio-system
        tracing:
          enabled: false
        prometheus:
          url: http://prometheus-server.prometheus.svc.cluster.local/
```

##### 2. [Envoy Access Logging](https://istio.io/latest/docs/tasks/observability/logs/access-log/#enable-envoys-access-logging)
Gateway, VirtualService ë“±ì„ êµ¬ì„±í•˜ê³  503 ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ istio-ingressgatewayì—ì„œ ë°œìƒí•œ ì˜¤ë¥˜ì¸ì§€ í˜¹ì€ ê° ì„œë¹„ìŠ¤ Envoy í”„ë¡ì‹œì—ì„œ ë°œìƒí•œ ì˜¤ë¥˜ì¸ì§€ë¥¼ í™•ì¸í•˜ë ¤ê³  kubectl logs ì»¤ë§¨ë“œë¥¼ ì‚¬ìš©í•˜ì˜€ìœ¼ë‚˜ Access ë¡œê·¸ê°€ ë³´ì´ì§€ ì•Šì•˜ë‹¤.  
Envoy access logë¥¼ í™œì„±í™” í•˜ê¸° ìœ„í•´ì„œëŠ” ì•„ë˜ì˜ Telemetryë¥¼ ë°°í¬í•œë‹¤.  

```yaml
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: mesh-default
  namespace: istio-system
spec:
  accessLogging:
    - providers:
      - name: envoy
```




---

## ğŸ“š References

[1] **Istio Architecture** - ê³µì‹ ì•„í‚¤í…ì²˜ ë¬¸ì„œ  
- https://istio.io/latest/docs/ops/deployment/architecture/

[2] **Kiali Troubleshooting** - Kiali FAQ  
- https://kiali.io/docs/faq/graph/#emptygraph
