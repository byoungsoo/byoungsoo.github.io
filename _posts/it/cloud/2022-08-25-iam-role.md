---
layout: post
title: "AWS IAM Role"
author: "Bys"
category: cloud
date: 2022-08-25 01:00:00
tags: aws iam role
---

# AWS IAM Role

## 1. IAM Role 
AWS IAM(Identity and Access Management) Roleì€ AWSì˜ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ì—­í• (Role)ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•´ í•„ìš”í•˜ë‹¤. 
ì•„ë¬´ë‚˜ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìœ¼ë©° ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼ í•  ìˆ˜ ìˆëŠ” ì—­í• ì„ ê°€ì§„ ìœ ì €, ì„œë¹„ìŠ¤ ë“±ë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤. 

ì¼ë°˜ì ì¸ ìƒí™©ì—ì„œ ì‚¬ìš©í•˜ëŠ” IAM Roleì˜ ì‚¬ìš©ì€ ì•„ë˜ì™€ ê°™ë‹¤. 
1. ì–´ë–¤ AWS Serviceê°€ ê°™ì€ ê³„ì •ì— ìˆëŠ” AWS Serviceì— ì ‘ê·¼í•˜ëŠ” ê²½ìš°
2. ì–´ë–¤ AWS Serviceê°€ ë‹¤ë¥¸ ê³„ì •ì— ìˆëŠ” AWS Serviceì— ì ‘ê·¼í•˜ëŠ” ê²½ìš°
3. Third-party web ìê²©ì¦ëª…ì—ì„œ ì ‘ê·¼ì´ í•„ìš”í•œ ê²½ìš° 
4. SAML 2.0 ì—°ë™ì„ ìœ„í•œ ì¸ì¦ì´ í•„ìš”í•œ ê²½ìš°

## 2. Create Role
1. Trust Relationship (Principle)
ë¡¤ì„ ìƒì„±í•˜ê²Œ ë˜ë©´ ì‚¬ìš©ìëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ê°ì²´(Trusted Entity)ë¥¼ ì„ íƒí•´ì•¼ í•œë‹¤. ì–´ë–¤ Trust Entityê°€ ë‚´ Roleì„ Assume ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ë¥¼ ê´€ë¦¬í•œë‹¤.  

Trust EntityëŠ” AWS Service, AWS account, WEB Identity, SAML 2.0 federation, Custom trust policy ì´ 5ê°€ì§€ì˜ í•­ëª©ì´ ìˆë‹¤. 
ìƒí™©ì— ë§ì¶°ì„œ ì ì ˆí•œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ê°ì²´ë¥¼ ë„£ì–´ì£¼ë©´ ëœë‹¤. ì„ íƒëœ í•­ëª©ì˜ ë¦¬ì†ŒìŠ¤ì— í•œí•˜ì—¬ AssumeRoleì´ ê°€ëŠ¥í•˜ë‹¤. 
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": [
                    "eks.amazonaws.com"
                ]
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

2. Permission
ì—­í• ì„ ê°€ì§„ Principleì´ í•  ìˆ˜ ìˆëŠ” ì •ì±…ì´ ì •ì˜ ë˜ì–´ ìˆë‹¤. 
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "autoscaling:DescribeAutoScalingGroups",
                "autoscaling:UpdateAutoScalingGroup",
                "ec2:AttachVolume",
                "ec2:AuthorizeSecurityGroupIngress",
                "ec2:CreateRoute",
                "ec2:CreateSecurityGroup",
                ......
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": "iam:CreateServiceLinkedRole",
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "iam:AWSServiceName": "elasticloadbalancing.amazonaws.com"
                }
            }
        }
    ]
}
```

ì´ëŸ¬í•œ ì¡°í•©ìœ¼ë¡œ ì—­í• ì´ ì •ì˜ë˜ê³  ì´ ì—­í• ì„ ê°€ì§„ ì„œë¹„ìŠ¤ëŠ” Permissionì— ì •ì˜ëœ Actionë“¤ì„ í•  ìˆ˜ ìˆë‹¤. 
<br>

## 2. Assume Role  
Aë¼ëŠ” ì‚¬ìš©ìê°€ sts:AssumeRole ê¶Œí•œì„ ê°€ì§€ê³  ìˆê³  ë§Œì•½ íŠ¹ì • Roleì´ Aìœ ì €ì— ëŒ€í•œ Trust Relationshipì´ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ Aë¼ëŠ” ì‚¬ìš©ìëŠ” íŠ¹ì • Roleë¡œ ì—­í• ì„ ë³€ê²½í•  ìˆ˜ ìˆë‹¤. 
ì´ ë•Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ Assume Role(Switch Role)ì´ë‹¤. íŠ¹ì • Roleë¡œ ë³€ê²½ì´ ë˜ë©´ í•´ë‹¹ Roleì— ì„¤ì •ëœ ëª¨ë“  ì •ì±…ì— ë”°ë¥¸ ê¶Œí•œì„ ìœ„ì„ ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.   

```bash
ASSUME_ROLE_CREDENTIALS=$(aws sts assume-role --role-arn arn:aws:iam::558846430793:role/test-role --role-session-name test --region ap-northeast-2)
export AWS_ACCESS_KEY_ID=$(echo $ASSUME_ROLE_CREDENTIALS | jq .Credentials.AccessKeyId | sed 's/"//g')
export AWS_SECRET_ACCESS_KEY=$(echo $ASSUME_ROLE_CREDENTIALS | jq .Credentials.SecretAccessKey | sed 's/"//g')
export AWS_SESSION_TOKEN=$(echo $ASSUME_ROLE_CREDENTIALS | jq .Credentials.SessionToken | sed 's/"//g')
```

<br>

## 3. Null Condition
í‚¤ì˜ ìœ ë¬´ë¥¼ íŒë‹¨í•˜ê¸° ìœ„í•´ ë‹¨ë…ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ì¡°ê±´ì´ë‹¤. ì¤‘ìš”í•œ ê²ƒì€ trueì´ë©´ í‚¤ì™€ ê°’ì´ ì—†ì–´ì•¼ í•˜ê³ , falseì´ë©´ í‚¤ì™€ ê°’ì´ ì—†ì–´ì•¼ í•œë‹¤. 
```json
{
  "Version": "2012-10-17",
  "Statement":{
      "Action":"ec2:*",
      "Effect":"Allow",
      "Resource":"*",
      "Condition":{"Null":{"aws:TokenIssueTime":"true"}}
  }
}
```
[Condition operator to check existence of condition keys](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_condition_operators.html)  
ì„ì‹œìê²©ì¦ëª…ì„ ì‚¬ìš©í•  ê²½ìš° aws:TokenIssueTime í‚¤ ê°’ì´ ì¡´ì¬í•œë‹¤. trueì´ê¸° ë•Œë¬¸ì— í‚¤ì™€ ê°’ì´ ì—†ì–´ì•¼ í•˜ëŠ”ë° ì¡´ì¬í•˜ë¯€ë¡œ í•´ë‹¹ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ëª»í•œë‹¤.  


ì•„ë˜ì˜ ë‚´ìš©ì„ ì´í•´í•˜ê¸° ìœ„í•œ ì‚¬ì „ ì§€ì‹ ì‚¬í•­ 
- AWS load balancer controllerëŠ” resourceìƒì„± ì‹œ 'elbv2.k8s.aws/cluster: ${clusterName}' Taggingì„ í•œë‹¤.  
- Nullì¡°ê±´ì€ ì¡°ê±´ì€ í‚¤ì˜ ìœ /ë¬´ë¥¼ íŒë‹¨í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ì¡°ê±´ ì´ë©° trueì™€ falseë¥¼ ì‚¬ìš©í•œë‹¤. trueì´ë©´ í‚¤ì™€ ê°’ì´ ì—†ì–´ì•¼ í•˜ê³ , falseì´ë©´ í‚¤ì™€ ê°’ì´ ì—†ì–´ì•¼ í•œë‹¤.  
- Null ì•ˆì— 2ê°œì˜ ì¡°ê±´ì€ ANDë¡œ ì—°ì‚°í•œë‹¤. [Evaluation logic for conditions with multiple keys or values](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_multi-value-conditions.html)  
- aws:RequestTag/key-nameëŠ” AWS ë¦¬ì†ŒìŠ¤ì— íƒœê·¸ë¥¼ ì§€ì •í•˜ê±°ë‚˜ íƒœê·¸ë¥¼ ì œê±°í•˜ëŠ” ìš”ì²­ì—ì„œ ì–´ë–¤ íƒœê·¸ í‚¤ ê°’ í˜ì–´ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆëŠ”ì§€ë¥¼ ì§€ì •í•œë‹¤. aws:ResourceTag/key-nameëŠ” ë¦¬ì†ŒìŠ¤ì— ì—°ê²°ëœ íƒœê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ í—ˆìš©í• ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤. 
  [Controlling access to AWS resources using tags](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_tags.html)  

1. ì˜ˆì‹œ: AWS load balancer controllerê°€ ELBìƒì„± ìš”ì²­í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ì •ì±…
```json
{
    "Effect": "Allow",
    "Action": [
        "elasticloadbalancing:CreateLoadBalancer",
        "elasticloadbalancing:CreateTargetGroup"
    ],
    "Resource": "*",
    "Condition": {
        "Null": {
            "aws:RequestTag/elbv2.k8s.aws/cluster": "false"
        }
    }
}
```
- "aws:RequestTag/elbv2.k8s.aws/cluster": "false" ì¡°ê±´ì˜ ì˜ë¯¸ëŠ” ELB ìƒì„±ì‹œ íƒœê·¸ ë“±ë¡ ìš”ì²­ì— 'elbv2.k8s.aws/cluster'í‚¤ì™€ ê°’ì´ ì¡´ì¬í•´ì•¼ ì¡°ê±´ì„ ë§Œì¡±í•œë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.  
- ì´ì— ë”°ë¼ AWS load balancer controllerëŠ” resourceìƒì„± ì‹œ 'elbv2.k8s.aws/cluster: ${clusterName}' Taggingì„ í•œë‹¤ê³  ì´í•´í•˜ë©´ ëœë‹¤. ì´ íƒœê·¸ ìƒì„± ìš”ì²­ì´ ì—†ìœ¼ë©´ ELBìƒì„± ê¶Œí•œì´ ì—†ê¸° ë•Œë¬¸ì´ë‹¤.  

2. ì˜ˆì‹œ: NLB, ALB, TargetGroupì— Tagë¥¼ ì¶”ê°€ í•˜ê³  ì‚­ì œí•  ë•Œ ì‚¬ìš©í•˜ëŠ” ì •ì±…
```json
{
    "Effect": "Allow",
    "Action": [
        "elasticloadbalancing:AddTags",
        "elasticloadbalancing:RemoveTags"
    ],
    "Resource": [
        "arn:aws:elasticloadbalancing:*:*:targetgroup/*/*",
        "arn:aws:elasticloadbalancing:*:*:loadbalancer/net/*/*",
        "arn:aws:elasticloadbalancing:*:*:loadbalancer/app/*/*"
    ],
    "Condition": {
        "Null": {
            "aws:RequestTag/elbv2.k8s.aws/cluster": "true",
            "aws:ResourceTag/elbv2.k8s.aws/cluster": "false"
        }
    }
}
```
- 'aws:ResourceTag/elbv2.k8s.aws/cluster": "false'ì˜ë¯¸ëŠ” ìì‹ ì„ í†µí•´ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ë¥¼ êµ¬ë³„í•˜ê¸° ìœ„í•´ ë¦¬ì†ŒìŠ¤ íƒœê·¸ì— 'elbv2.k8s.aws/cluster'í‚¤ì™€ ê°’ì´ ì¡´ì¬í•´ì•¼ í•œë‹¤ëŠ” ì¡°ê±´ì„ ì„¤ì •í•œë‹¤.  
- "aws:RequestTag/elbv2.k8s.aws/cluster": "true"ì˜ë¯¸ëŠ” ì´ë¯¸ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ì— íƒœê¹…ì„ ë³€ê²½í•  ë•Œ 'elbv2.k8s.aws/cluster' íƒœê¹…ì€ ë³€ê²½í•˜ë©´ ì•ˆë˜ê¸° ë•Œë¬¸ì— ìš”ì²­ íƒœê·¸ì— í•´ë‹¹í•˜ëŠ” í‚¤ê°€ ì—†ì–´ì•¼ í•œë‹¤ëŠ” ì¡°ê±´ì„ ì„¤ì •í•œë‹¤.  


## 5. ì°¸ê³ 
- Federation
IAM supports identity federation for delegated access to the AWS Management Console or AWS APIs, such as an Amazon S3 bucket or an Amazon DynamoDB table. With identity federation, external identities (federated users) are granted secure access to resources in your AWS account
without having to create IAM users. These external identities can come from your corporate directory (for example Windows Active Directory).


---

## ğŸ“š References

[1] **AWS IAM Trust Policies** - AWS ë³´ì•ˆ ë¸”ë¡œê·¸  
- https://aws.amazon.com/ko/blogs/security/how-to-use-trust-policies-with-iam-roles/