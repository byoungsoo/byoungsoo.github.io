---
layout: post
title: "EKS metric-serversë¥¼ í†µí•œ íŒŒë“œ Autoscaling"
author: "Bys"
category: cloud
date: 2023-01-02 01:00:00
tags: hpa kubernetes eks aws
---

# [HPA](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/)
HPAëŠ” Deployment, StatefulSetê³¼ ê°™ì€ workload resourceë¥¼ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë©° workloadì˜ í¬ê¸°ë¥¼ ìë™ìœ¼ë¡œ ìˆ˜ìš”ì— ë§ê²Œ í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•œë‹¤. 
> a HorizontalPodAutoscaler automatically updates a workload resource (such as a Deployment or StatefulSet), with the aim of automatically scaling the workload to match demand.  

HPAë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” Metric Serverë¥¼ ë³„ë„ë¡œ ë°°í¬í•˜ì—¬ì•¼ í•œë‹¤. [Metric Server Install](https://docs.aws.amazon.com/eks/latest/userguide/metrics-server.html), [Metric Server Configuration](https://github.com/kubernetes-sigs/metrics-server/blob/99f57694b183b94f423b6154987c944ced2edd46/docs/command-line-flags.txt)  


- Metrics server
  - Cluster addon component that collects and aggregates resource metrics pulled from each kubelet. The API server serves Metrics API for use by HPA, VPA, and by the kubectl top command. Metrics Server is a reference implementation of the Metrics API. Metrics Server collects resource metrics from Kubelets and exposes them in Kubernetes apiserver through Metrics API for use by Horizontal Pod Autoscaler and Vertical Pod Autoscaler. 
    - ê° Kubeletì—ì„œ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ê³  ì§‘ê³„í•˜ëŠ” Add-on ì»´í¬ë„ŒíŠ¸ë‹¤. HPA, VPA, kubectl top ëª…ë ¹ì„ ìœ„í•´ì„œ Metrics APIë¥¼ ì œê³µí•œë‹¤. 
  - Metric ServerëŠ” Add-onsë¡œ ì œê³µëœë‹¤. 
  - HPAë¥¼ ì‚¬ìš©í•˜ëŠ” ì¼ë°˜ì ì¸ ë°©ë²•ì€ aggregated API(metrics.k8s.io, custom.metrics.k8s.io, ë˜ëŠ” external.metrics.k8s.io)ë¡œ ë¶€í„° ë©”íŠ¸ë¦­ì„ ê°€ì ¸ì˜¤ë„ë¡ ì„¤ì •í•˜ëŠ” ê²ƒì´ë‹¤. (aggregated APIëŠ” Kubernetesë¥¼ í™•ì¥í•˜ê¸° ìœ„í•´ í´ëŸ¬ìŠ¤í„°ì— ì¶”ê°€ì ì¸ APIë¥¼ ë°°í¬í•  ìˆ˜ ìˆë„ë¡ í•œ ê²ƒì´ë‹¤.)
  - Metric Serverë¥¼ ë°°í¬í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ 'metrics.k8s.io' APIë¥¼ ì œê³µí•˜ë„ë¡ ì„¤ì •ëœë‹¤.  
      ```yaml
      apiVersion: apiregistration.k8s.io/v1
      kind: APIService
      metadata:
        labels:
          k8s-app: metrics-server
        name: v1beta1.metrics.k8s.io
      spec:
        group: metrics.k8s.io
        groupPriorityMinimum: 100
        insecureSkipTLSVerify: true
        service:
          name: metrics-server
          namespace: kube-system
        version: v1beta1
        versionPriority: 100
      ```
  - Metrics API: Kubernetes API supporting access to CPU and memory used for workload autoscaling. To make this work in your cluster, you need an API extension server that provides the Metrics API.
    - Metrics APIëŠ” HPA, VPAë˜ëŠ” ì‚¬ìš©ìê°€ kubectlì„ í†µí•´  metricì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ CPUë‚˜ ë©”ëª¨ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” Kubernetes APIë‹¤. ì¦‰, API ì„œë²„ëŠ” HPA, VPA ë° kubectl top ëª…ë ¹ì—ì„œ ì‚¬ìš©í•  Metrics APIë¥¼ ì œê³µí•œë‹¤. ê·¸ë¦¬ê³  Metrics ServerëŠ” Metrics APIì˜ ì°¸ì¡° êµ¬í˜„ì…ë‹ˆë‹¤. 

<br>

## 1. [ë™ì‘ë°©ë²•](https://kubernetes.io/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/)  

![metric-server-architecture](/assets/it/cloud/eks/metric-server-architecture.png){: width="70%" height="auto"}

![hpa001](/assets/it/cloud/eks/hpa001.png){: width="95%" height="auto"}  

1. cAdvisorê°€ Podë‚´ Containerë“¤ì˜ Metricsì„ ìˆ˜ì§‘í•¨.
2. kubeletì´ cAdvisorê°€ ë…¸ì¶œí•œ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•¨.
3. metric-serverê°€ kubeletìœ¼ë¡œ ë¶€í„° metric ë¦¬ì†ŒìŠ¤ë¥¼ ìˆ˜ì§‘í•¨. ì´ ì£¼ê¸°ëŠ” --metric-resolution=15s ì˜µì…˜ì— ë”°ë¼ ìˆ˜ì§‘ ë¨ 
    ```bash
    $ kubectl logs -f metrics-server-58fd485c7-nnltl -n kube-system
    # Kubeletìœ¼ë¡œë¶€í„° ë©”íŠ¸ë¦­ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆë‹¤. 
    I1222 15:01:24.847741       1 scraper.go:115] "Scraping metrics from nodes" nodeCount=2
    I1222 15:01:24.855038       1 scraper.go:137] "Scraping node" node="ip-10-20-10-235.ap-northeast-2.compute.internal"
    I1222 15:01:24.857187       1 scraper.go:137] "Scraping node" node="ip-10-20-11-91.ap-northeast-2.compute.internal"
    I1222 15:01:24.877046       1 scraper.go:172] "Scrape finished" duration="29.273444ms" nodeCount=2 podCount=17
    ```
4. API ì„œë²„ëŠ” Metrics APIë¥¼ ì œê³µí•˜ë¯€ë¡œì¨ ì‚¬ìš©ì, HPAë“±ì—ê²Œ APIë¥¼ ì œê³µí•  ìˆ˜ ìˆë‹¤.  
  ë”°ë¼ì„œ, ì•„ë˜ kubectl ì»¤ë§¨ë“œë¥¼ í†µí•´ ë©”íŠ¸ë¦­ì„ ì¡°íšŒí•˜ë©´ ì‹¤ì œë¡œëŠ” ë©”íŠ¸ë¦­ ì„œë²„ì—ì„œ ì•„ë˜ì™€ ê°™ì´ ë¡œê·¸ê°€ ë³´ì¸ë‹¤. (configured by - --v=5)
    ```bash
    $ kubectl get --raw "/apis/metrics.k8s.io/v1beta1/nodes/ip-10-20-10-235.ap-northeast-2.compute.internal" | jq '.'

    $ kubectl logs -f metrics-server-58fd485c7-nnltl -n kube-system
    # srcIP=x-ENIì˜ ì£¼ì†Œ ì¤‘ í•˜ë‚˜ë‹¤. ë‚´ ë¡œì»¬ -> API server -> metrics-serverë¡œ ì™”ê¸° ë•Œë¬¸ì—. 
    I1222 15:01:10.534483       1 handler.go:143] metrics-server: GET "/apis/metrics.k8s.io/v1beta1/nodes/ip-10-20-10-235.ap-northeast-2.compute.internal" satisfied by gorestful with webservice /apis/metrics.k8s.io/v1beta1
    I1222 15:01:10.534721       1 httplog.go:129] "HTTP" verb="GET" URI="/apis/metrics.k8s.io/v1beta1/nodes/ip-10-20-10-235.ap-northeast-2.compute.internal" latency="432.784Âµs" userAgent="kubectl/v1.26.0 (linux/amd64) kubernetes/b46a3f8" audit-ID="ae15fa19-9c33-4ebf-8f7d-15931ba355e0" srcIP="10.20.10.23:40266" resp=200
    ```
    ì•„ë˜ëŠ” HPAë¥¼ ë°°í¬í•œ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ Metrics Serverë¡œê·¸ì´ë‹¤.  
    
      ```bash
      # ì•„ë˜ë„ ì£¼ê¸°ì ìœ¼ë¡œ ê´€ì°°ë˜ëŠ” ë¡œê·¸ì´ë©° ì´ëŠ” php-apche hpaì—ì˜í•´ ì£¼ê¸°ì ìœ¼ë¡œ 15ì´ˆë§ˆë‹¤ ì¡°íšŒë˜ëŠ” ê²°ê³¼ë‹¤.  
      I1222 15:01:37.041375       1 handler.go:143] metrics-server: GET "/apis/metrics.k8s.io/v1beta1/namespaces/default/pods" satisfied by gorestful with webservice /apis/metrics.k8s.io/v1beta1
      I1222 15:01:37.041560       1 httplog.go:129] "HTTP" verb="LIST" URI="/apis/metrics.k8s.io/v1beta1/namespaces/default/pods?labelSelector=run%3Dphp-apache" latency="4.32772ms" userAgent="kube-controller-manager/v1.21.14 (linux/amd64) kubernetes/b07006b/system:serviceaccount:kube-system:horizontal-pod-autoscaler" audit-ID="de1229ce-5f8f-4636-8698-0ff3003aca05" srcIP="10.20.11.208:32858" resp=200

      I1222 15:01:52.104167       1 handler.go:143] metrics-server: GET "/apis/metrics.k8s.io/v1beta1/namespaces/default/pods" satisfied by gorestful with webservice /apis/metrics.k8s.io/v1beta1
      I1222 15:01:52.104352       1 httplog.go:129] "HTTP" verb="LIST" URI="/apis/metrics.k8s.io/v1beta1/namespaces/default/pods?labelSelector=run%3Dphp-apache" latency="3.059605ms" userAgent="kube-controller-manager/v1.21.14 (linux/amd64) kubernetes/b07006b/system:serviceaccount:kube-system:horizontal-pod-autoscaler" audit-ID="b57ab53f-0194-41e2-99b1-50c7dc429e03" srcIP="10.20.11.208:32858" resp=200

      I1222 15:02:07.127963       1 handler.go:143] metrics-server: GET "/apis/metrics.k8s.io/v1beta1/namespaces/default/pods" satisfied by gorestful with webservice /apis/metrics.k8s.io/v1beta1
      I1222 15:02:07.128194       1 httplog.go:129] "HTTP" verb="LIST" URI="/apis/metrics.k8s.io/v1beta1/namespaces/default/pods?labelSelector=run%3Dphp-apache" latency="4.949269ms" userAgent="kube-controller-manager/v1.21.14 (linux/amd64) kubernetes/b07006b/system:serviceaccount:kube-system:horizontal-pod-autoscaler" audit-ID="5f545f72-bb1b-4cce-a7e6-a5681235f1bc" srcIP="10.20.11.208:32858" resp=200

      I1222 15:02:22.205786       1 handler.go:143] metrics-server: GET "/apis/metrics.k8s.io/v1beta1/namespaces/default/pods" satisfied by gorestful with webservice /apis/metrics.k8s.io/v1beta1
      I1222 15:02:22.206026       1 httplog.go:129] "HTTP" verb="LIST" URI="/apis/metrics.k8s.io/v1beta1/namespaces/default/pods?labelSelector=run%3Dphp-apache" latency="3.820725ms" userAgent="kube-controller-manager/v1.21.14 (linux/amd64) kubernetes/b07006b/system:serviceaccount:kube-system:horizontal-pod-autoscaler" audit-ID="b591499b-e8f3-4313-9f7a-ab2395eaac70" srcIP="10.20.11.208:32858" resp=200
      ```

5. kube-controller(HPA controller)ê°€ metrics APIì˜ ë°ì´í„°ë¥¼ ë³´ê³  RS replicaë¥¼ ì¡°ì •í•¨  (15ì´ˆ)


## 2. HPA í…ŒìŠ¤íŠ¸  
1. ì•„ë˜ì™€ ê°™ì´ php-apacheì— ëŒ€í•œ Deployment, Service, HPA ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í•œë‹¤.  

    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: php-apache1
    spec:
      selector:
        matchLabels:
          run: php-apache1
      replicas: 2
      template:
        metadata:
          labels:
            run: php-apache1
        spec:
          containers:
          - name: php-apache1
            image: registry.k8s.io/hpa-example
            ports:
            - containerPort: 80
            resources:
              limits:
                cpu: 500m
              requests:
                cpu: 200m
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: php-apache1
      labels:
        run: php-apache1
    spec:
      ports:
      - port: 80
      selector:
        run: php-apache1
    ---
    apiVersion: autoscaling/v1
    kind: HorizontalPodAutoscaler
    metadata:
      name: php-apache1
      namespace: default
    spec:
      maxReplicas: 10
      minReplicas: 2
      scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: php-apache1
      targetCPUUtilizationPercentage: 50
    ```

2. ì•„ë˜ì™€ ê°™ì´ curlì„ ìš”ì²­í•  ìˆ˜ ìˆëŠ” Deploymentë¥¼ ë°°í¬í•œë‹¤.  
    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: netutil
      labels:
        app: netutil
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: netutil
      template:
        metadata:
          labels:
            app: netutil
        spec:
          containers:
          - name: netutil
            image: praqma/network-multitool
    ```


### HPA ë¡œì§  
HPAëŠ” desiredìˆ˜ë¥¼ ì•„ë˜ì™€ ê°™ì´ ê³„ì‚°í•œë‹¤.  
`desiredReplicas = ceil[currentReplicas * ( currentMetricValue / desiredMetricValue )]`

ë§Œì•½ HPAì— CPUê¸°ë°˜ scale ì„¤ì •ì´ ë˜ì—ˆìœ¼ë‚˜ íŒŒë“œ Manifestì— request.cpuê°€ ì •ì˜ë˜ì§€ ì•Šì€ ê²½ìš°ì—ëŠ” HPAê°€ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤. 

### ë¶€í•˜ & ê²°ê³¼ í™•ì¸ 

#### Test1
ë¶€í•˜ ë°œìƒ
```bash
$ kubectl exec -it netutil-669f67cb94-2hdns -- /bin/bash
$ while true; do curl http://php-apache1; sleep 0.3; done
```

ê²°ê³¼ í™•ì¸
```bash
$ while true; do date; k get hpa php-apache1; sleep 10; done
#################### Result ####################
Thu Jan  5 09:57:28 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   0%/50%    2         10        2          39h
Thu Jan  5 09:57:38 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   26%/50%   2         10        2          39h
Thu Jan  5 09:57:48 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   26%/50%   2         10        2          39h
Thu Jan  5 09:57:58 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   52%/50%   2         10        2          39h
Thu Jan  5 09:58:08 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   51%/50%   2         10        2          39h
Thu Jan  5 09:58:18 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   51%/50%   2         10        2          39h
Thu Jan  5 09:58:29 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   52%/50%   2         10        2          39h
Thu Jan  5 09:58:39 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   52%/50%   2         10        2          39h
Thu Jan  5 09:58:49 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   52%/50%   2         10        2          39h
Thu Jan  5 09:58:59 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   50%/50%   2         10        2          39h
Thu Jan  5 09:59:09 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   51%/50%   2         10        2          39h
Thu Jan  5 09:59:19 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   51%/50%   2         10        2          39h
Thu Jan  5 09:59:29 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   52%/50%   2         10        2          39h
Thu Jan  5 09:59:40 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   56%/50%   2         10        2          39h
Thu Jan  5 09:59:50 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   56%/50%   2         10        2          39h
Thu Jan  5 10:00:00 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   49%/50%   2         10        3          39h
Thu Jan  5 10:00:10 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   33%/50%   2         10        3          39h
Thu Jan  5 10:00:20 KST 2023
```

```bash
$ while true; do date; k get po -l run=php-apache1; sleep 5; done
#################### Result ####################
Thu Jan  5 09:59:33 KST 2023
NAME                          READY   STATUS    RESTARTS   AGE
php-apache1-8445df799-bdlln   1/1     Running   0          39h
php-apache1-8445df799-jnmtx   1/1     Running   0          39h
Thu Jan  5 09:59:36 KST 2023
NAME                          READY   STATUS              RESTARTS   AGE
php-apache1-8445df799-67jjv   0/1     ContainerCreating   0          0s
php-apache1-8445df799-bdlln   1/1     Running             0          39h
php-apache1-8445df799-jnmtx   1/1     Running             0          39h
Thu Jan  5 09:59:39 KST 2023
NAME                          READY   STATUS    RESTARTS   AGE
php-apache1-8445df799-67jjv   1/1     Running   0          3s
php-apache1-8445df799-bdlln   1/1     Running   0          39h
php-apache1-8445df799-jnmtx   1/1     Running   0          39h
```

- 51%, 52% êµ¬ê°„
    > ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ë©´ ì¤‘ê°„ 51%, 52%êµ¬ê°„ì—ì„œëŠ” Target ì„ê³„ì¹˜ì¸ 50%ë¥¼ ë„˜ì—ˆì§€ë§Œ íŒŒë“œê°€ Autoscalingë˜ì§€ ì•Šì•˜ë‹¤. ceil((52/50) * 2) = ceil(2.08) = 3 ì´ ë‚˜ì˜¤ëŠ” ê²ƒì„ì—ë„ ë¶ˆêµ¬í•˜ê³  ì¦ê°€í•˜ì§€ ì•Šì€ ì´ìœ ëŠ” ë¬´ì—‡ì¼ê¹Œ?

    ê³µì‹ë¬¸ì„œì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì´ì•¼ê¸°í•˜ê³ ìˆë‹¤. ë¹„ìœ¨ì´ 1ì— ì¶©ë¶„íˆ ê°€ê¹ë‹¤ë©´ ìŠ¤ì¼€ì¼ë§ ê±´ë„ˆë›´ë‹¤. í—ˆìš©ì˜¤ì°¨ëŠ” 0.1ì˜ defaultë¥¼ ê°€ì§€ê³  ìˆë‹¤. (`--horizontal-pod-autoscaler-tolerance`)
    > The control plane skips any scaling action if the ratio is sufficiently close to 1.0 (within a globally-configurable tolerance, 0.1 by default).

    ë”°ë¼ì„œ, 2.08ì€ 0.1ë§Œí¼ì˜ í—ˆìš©ì˜¤ì°¨ì—ì„œ ë¬´ì‹œê°€ ëœë‹¤.  

- 56% êµ¬ê°„
    > íŒŒë“œëŠ” ì •í™•í•˜ê²Œ 2.1ì„ ë„˜ê¸´ 56% êµ¬ê°„ì´ ë˜ìë§ˆì íŒŒë“œê°€ í•˜ë‚˜ ì¦ê°€í•˜ì˜€ë‹¤.   


#### Test2
ë¶€í•˜ ë°œìƒ
```bash
$ kubectl exec -it netutil-669f67cb94-2hdns -- /bin/bash
$ while true; do curl http://php-apache1; sleep 0.1; done
```

ê²°ê³¼ í™•ì¸
```bash
$ while true; do date; k get hpa php-apache1; sleep 10; done
#################### Result ####################
Thu Jan  5 10:28:49 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   0%/50%    2         10        2          40h
Thu Jan  5 10:28:59 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   0%/50%    2         10        2          40h
Thu Jan  5 10:29:09 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   16%/50%   2         10        2          40h
Thu Jan  5 10:29:19 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   16%/50%   2         10        2          40h
Thu Jan  5 10:29:30 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   91%/50%   2         10        2          40h
Thu Jan  5 10:29:40 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   93%/50%   2         10        4          40h
Thu Jan  5 10:29:50 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   93%/50%   2         10        4          40h
Thu Jan  5 10:30:00 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   45%/50%   2         10        4          40h
Thu Jan  5 10:30:10 KST 2023
NAME          REFERENCE                TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache1   Deployment/php-apache1   48%/50%   2         10        4          40h
```

```bash
$ while true; do date; k get po -l run=php-apache1; sleep 5; done
#################### Result ####################
NAME                          READY   STATUS    RESTARTS   AGE
php-apache1-8445df799-67jjv   1/1     Running   0          29m
php-apache1-8445df799-bdlln   1/1     Running   0          39h
Thu Jan  5 10:29:23 KST 2023
NAME                          READY   STATUS              RESTARTS   AGE
php-apache1-8445df799-67jjv   1/1     Running             0          29m
php-apache1-8445df799-bdlln   1/1     Running             0          39h
php-apache1-8445df799-ffff6   0/1     ContainerCreating   0          1s
php-apache1-8445df799-r5z8p   0/1     ContainerCreating   0          1s
Thu Jan  5 10:29:26 KST 2023
NAME                          READY   STATUS    RESTARTS   AGE
php-apache1-8445df799-67jjv   1/1     Running   0          29m
php-apache1-8445df799-bdlln   1/1     Running   0          39h
php-apache1-8445df799-ffff6   1/1     Running   0          4s
php-apache1-8445df799-r5z8p   1/1     Running   0          4s
```

- 91~93% êµ¬ê°„
> ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ë©´ 91~93% êµ¬ê°„ì´ í™•ì¸ë˜ì ë°”ë¡œ PodëŠ” 4ê°œë¡œ ì¦ê°€í•˜ì˜€ë‹¤.  
> `ceil(2 * (93/50)) = ceil(2* 1.86) = ceil(3.72) = 4`

- 48% êµ¬ê°„
> íŒŒë“œê°€ 4ê°œë¡œ ì¦ê°€í•˜ê³  48%ë¥¼ ìœ ì§€í•œë‹¤. ì´ ë•ŒëŠ” ì•„ë˜ì™€ ê°™ì´ desiredReplicaìˆ˜ê°€ currentReplica ìˆ˜ì™€ ê°™ê¸° ë•Œë¬¸ì— ìœ ì§€í•œë‹¤.  
> `ceil(4 * (48/50)) = ceil(4* 0.96) = ceil(3.84) = 4`



---

## ğŸ“š References

[1] **kubernetes-sigs/metrics-server**  
- https://github.com/kubernetes-sigs/metrics-server

[2] **High Availability**  
- https://kubernetes-sigs.github.io/metrics-server/#:~:text=command%20line%20flag-,High%20Availability,-Latest%20Metrics%20Server

[3] **metric-server ê°€ìš©ì„±**  
- https://nangman14.tistory.com/81

[4] **Resource metrics pipeline**  
- https://kubernetes.io/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/
