---
layout: post
title: "CDK - EKS Cluster"
author: "Bys"
category: cloud
date: 2023-08-30 01:00:00
tags: aws cloud eks cdk
---


# [CDK](https://docs.aws.amazon.com/cdk/v2/guide/home.html)
CDKë€ AWS Cloud Development Kitë¡œ ì†ŒìŠ¤ì½”ë“œ ê°œë°œì„ í†µí•´ CloudFormationì„ ë°°í¬í•˜ê³  AWSë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤. 


## 1. CDK ì‹œì‘í•˜ê¸°
```bash
# Init
project_name=eks-test
cd ~/workspace/cdk
mkdir $project_name
cd $project_name
cdk init --language typescript
```
ì»¤ë§¨ë“œë¥¼ ìˆ˜í–‰í•˜ê³  ë‚˜ë©´ bin, lib ë“±ì˜ í´ë” ë° íŒŒì¼ë“¤ì´ ìƒì„±ëœë‹¤. 
- bin í´ë”ì—ëŠ” $project_name.ts íŒŒì¼ì´ ìƒì„±ëœë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì´ ê³³ì—ëŠ” í™˜ê²½ë³€ìˆ˜ ë“±ì„ ì„¤ì •í•œë‹¤.
- lib í´ë”ì—ëŠ” eks-test-stack.ts íŒŒì¼ì´ ìƒì„±ëœë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì´ ê³³ì—ì„œ ìƒì„±í•  ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•œë‹¤.  


AWSì—ì„œëŠ” CDKì— í•„ìš”í•œ ì—¬ëŸ¬ ëª¨ë“ˆì„ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•´ì£¼ê³  ìˆë‹¤. EKSê°™ì€ ê²½ìš° [aws-cdk-lib.aws_eks module](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_eks-readme.html)ë¥¼ í†µí•´ ìƒì„±í•  ìˆ˜ ìˆìœ¼ë©° ë‹¤ì–‘í•œ ê¸°ë³¸ ìƒ˜í”Œì„ ì œê³µí•œë‹¤.  

ì´ëŸ¬í•œ Libë¥¼ ì¶”ê°€í•˜ì—¬ ì‰½ê²Œ AWS ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í•  ìˆ˜ ìˆìœ¼ë©° ë‹¤ìŒ ì¥ì—ì„œ ì‹¤ì œ ìƒ˜í”Œ ì†ŒìŠ¤ì½”ë“œë¥¼ ë°°í¬í•˜ëŠ” ë°©ë²•ì„ í™•ì¸í•œë‹¤.  

<br>

## 2. CDK ì†ŒìŠ¤ ìˆ˜ì • 
- bin
  - biní´ë”ì—ëŠ” ${project_name}.ts íŒŒì¼ì´ ìƒì„±ëœë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì´ ê³³ì—ëŠ” í™˜ê²½ë³€ìˆ˜ ë“±ì„ ì„¤ì •í•œë‹¤.
    ```typescript
    import 'source-map-support/register';
    import * as cdk from 'aws-cdk-lib';
    import { EksTestStack } from '../lib/eks-test-stack';

    const app = new cdk.App();
    new EksTestStack(app, 'EksTestStack', {
      /* If you don't specify 'env', this stack will be environment-agnostic.
      * Account/Region-dependent features and context lookups will not work,
      * but a single synthesized template can be deployed anywhere. */
  
      /* Uncomment the next line to specialize this stack for the AWS Account
      * and Region that are implied by the current CLI configuration. */
      // env: { account: process.env.CDK_DEFAULT_ACCOUNT, region: process.env.CDK_DEFAULT_REGION },
  
      /* Uncomment the next line if you know exactly what Account and Region you
      * want to deploy the stack to. */
      env: { account: '11111222223', region: 'ap-southeast-2' },

      /* For more information, see https://docs.aws.amazon.com/cdk/latest/guide/environments.html */
    });
    ```
- lib
  - libí´ë”ì—ëŠ” ${project_name}-stack.ts íŒŒì¼ì´ ìƒì„±ëœë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì´ ê³³ì—ì„œ ìƒì„±í•  ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•œë‹¤.  
    ```javascript
    import * as cdk from 'aws-cdk-lib';
    //import * as iam from 'aws-cdk-lib/aws-iam';
    import * as eks from 'aws-cdk-lib/aws-eks';
    //import * as ec2 from 'aws-cdk-lib/aws-ec2';
    //import * as lambda from 'aws-cdk-lib/aws-lambda';
    import { KubectlV27Layer } from '@aws-cdk/lambda-layer-kubectl-v27';
    import { Construct } from 'constructs';
    // import * as sqs from 'aws-cdk-lib/aws-sqs';

    export class EksTestStack extends cdk.Stack {
      constructor(scope: Construct, id: string, props?: cdk.StackProps) {
        super(scope, id, props);

        const cluster = new eks.Cluster(this, 'test-eks', {
        version: eks.KubernetesVersion.V1_27,
        kubectlLayer: new KubectlV27Layer(this, 'kubectl'),
        albController: {
          version: eks.AlbControllerVersion.V2_5_1,
          // policy: document, //policy ì¶”ê°€
        },
        });
      }
    }
    ```

- package.json  
  @aws-cdk/lambda-layer-kubectl-v27 ë‹¤ìŒ ëª¨ë“ˆì„ package.jsonì— ì¶”ê°€í•´ì£¼ì–´ì•¼ í•œë‹¤. 
  ```json
    "dependencies": {
      "@aws-cdk/lambda-layer-kubectl-v27": "^2.0.0",
      "aws-cdk-lib": "2.91.0",
      "constructs": "^10.0.0",
      "source-map-support": "^0.5.21"
    }
  ```

<br>

## 3. ë°°í¬í•˜ê¸°

  ```bash
  # Install dependencies in package.json
  $ npm install 

  $ npm run build

  $ cdk deploy
  âœ¨  Synthesis time: 2.5s
  ......
  Do you wish to deploy these changes (y/n)? y
  EksTestStack: deploying... [1/1]
  EksTestStack: creating CloudFormation changeset...

  âœ…  EksTestStack

  âœ¨  Deployment time: 966.01s

  Stack ARN:
  arn:aws:cloudformation:ap-southeast-2:558846430793:stack/EksTestStack/3e1292f0-4704-11ee-bcb5-025affa237e8

  âœ¨  Total time: 968.5s
  ```

ì´ë ‡ê²Œ ë°°í¬ë¥¼ ì§„í–‰í•˜ê²Œ ë˜ë©´ CloudFormation ìŠ¤íƒì„ ìƒì„±í•˜ê²Œ ë˜ë©° CloudFormationì„ í†µí•´ AWS ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í•˜ê²Œ ëœë‹¤. 


---

## ğŸ“š References

[1] **aws-cdk-lib.aws_eks module**  
- [1] https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_eks-readme.html
