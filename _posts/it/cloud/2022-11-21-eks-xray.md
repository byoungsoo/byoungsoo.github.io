---
layout: post
title: "EKS XRay ì ìš©í•˜ê¸° (Java, SpringBoot, EKS, Xray)"
author: "Bys"
category: cloud
date: 2022-11-21 01:00:00
tags: aws eks xray
---

# AWS XRay
AWS XRay ì„œë¹„ìŠ¤ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ ì¶”ì  ì„œë¹„ìŠ¤ë‹¤. ê°„ë‹¨í•˜ê²ŒëŠ” Applicationì— ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ë“¤ì— ëŒ€í•´ì„œ ì¶”ì ì„ í•´ì£¼ëŠ” ì„œë¹„ìŠ¤ë‹¤. Applicationì—ëŠ” Agentê°€ ì„¤ì¹˜ë˜ëŠ” ê²ƒì´ë©° XRay ì„œë²„ëŠ” ë³„ë„ë¡œ ì„¤ì¹˜í•˜ì—¬ AWS XRayì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆë‹¤. 
> [1] Use a Filter to instrument incoming HTTP requests. When you add the X-Ray servlet filter to your application, the X-Ray SDK for Java creates a segment for each sampled request. This segment includes timing, method, and disposition of the HTTP request. Additional instrumentation creates subsegments on this segment.

ë”°ë¼ì„œ, AWS XRayë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ê°„ë‹¨í•˜ê²Œ ì•„ë˜ì™€ ê°™ì€ ì„¤ì •ë“¤ì´ í•„ìš”í•˜ë‹¤. 
1. AWS XRayë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” Applicationì— XRay agent(Libraries)ë¥¼ ì ìš©í•œë‹¤. 
2. XRay ì„œë²„ë¥¼ ì„¤ì¹˜
3. ê¶Œí•œì„¤ì •

ì—¬ê¸°ì„œ ì„¤ëª…í•  êµ¬ì¡°ëŠ” Podì•ˆì— XRayê°€ ì„¤ì •ëœ Applicationì´ ìˆê³ , Sidecar Patternìœ¼ë¡œ ì‚¬ìš©ì„ xray-daemonì„ ë„ìš´ë‹¤. ê·¸ëŸ¬ë©´ ê°™ì€ íŒŒë“œì—ì„œëŠ” localhostí†µì‹ ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— agentëŠ” localhost:2000 UDPí¬íŠ¸ë¡œ í†µì‹ ì„ í•˜ê¸° ë•Œë¬¸ì— ë³„ë„ì˜ ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì—†ì´ xray-daemonì—ì„œ ìš”ì²­ì„ ë°›ì•„ ì²˜ë¦¬í•œë‹¤.  


## XRay ê¶Œí•œ ì„¤ì •  
Podê°€ UDPí¬íŠ¸ë¡œ ìˆ˜ì‹ í•˜ëŠ” Daemonì„ í†µí•´ XRayë¡œ segmentsë¥¼ ë³´ë‚´ë©´ X-Ray daemonì€ íì— ìŒ“ì•˜ë‹¤ê°€ XRayë¡œ ë°°ì¹˜ ì—…ë¡œë“œí•œë‹¤.  
ì´ ë•Œ X-Rayì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ì…‹íŒ…í•´ì£¼ì–´ì•¼ í•˜ë©° Podì˜ ServiceAccountì— ì„¤ì •ëœ ê¶Œí•œì— ë”°ë¼ ì‘ë™í•œë‹¤.  

ë¨¼ì € ServiecAccountì— ì„¤ì •í•  ê¶Œí•œì„ ì…‹íŒ…í•œë‹¤.  

`AWSEKSXrayRole`  

CreateRoleì„ í•˜ì—¬ AWSEKSXrayRoleì„ ë§Œë“ ë‹¤. PolicyëŠ” AWSXrayFullAccess ê¶Œí•œì„ ì£¼ë©° Trust Relationshipsë¥¼ ì•„ë˜ì™€ ê°™ì´ ì…‹ì—…í•œë‹¤.  
Federatedê°’ì€ arn:aws:iam::111122223333:oidc-provider/EKS_OpenID_Connect_Provider_URL ê°’ì´ë‹¤.  
StringEqualsì— oidc:subì— ë“¤ì–´ê°€ëŠ” ê°’ìœ¼ë¡œëŠ” ì‚¬ìš©í•  serviceaccountë¥¼ ì ì–´ì£¼ë©´ ëœë‹¤.  


```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::111122223333:oidc-provider/oidc.eks.ap-northeast-2.amazonaws.com/id/111122223333DAB9000C5839D1829CA11"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "oidc.eks.ap-northeast-2.amazonaws.com/id/111122223333DAB9000C5839D1829CA11:aud": "sts.amazonaws.com",
          "oidc.eks.ap-northeast-2.amazonaws.com/id/111122223333DAB9000C5839D1829CA11:sub": "system:serviceaccount:<namespace>:<serviceaccount_name>",
        }
      }
    }
  ]
}
```
<br>

Applicationì„ ìœ„í•œ ServiceAccountë¥¼ ë³„ë„ ìƒì„±í•˜ì§€ ì•Šì•˜ë‹¤ë©´ Applicationì´ ì¡´ì¬í•˜ëŠ” namespaceì˜ default ServiceAccountë¡œ ë™ì‘í•˜ë©° ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ annotaionsì— roleì„ ì¶”ê°€í•œë‹¤.  
```bash
kubectl edit sa default -n namespace
```
```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::111122223333:role/AWSEKSXrayRole
......
```
<br>

ê¶Œí•œì„¤ì •ì„ í•œ í›„ ë°ëª¬ì„ ë„ìš°ë©´ ì •ìƒì ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì€ ë¡œê·¸ ë©”ì„¸ì§€ê°€ ë³´ì¸ë‹¤.  
```bash
[Info] Successfully sent batch of 1 segments 
[Info] Successfully sent batch of 1 segments 
[Info] Successfully sent batch of 1 segments 
```
<br>

## XRay daemon ì„¤ì •  
`X-Ray Daemon`
X-Rayë¥¼ ë„ìš°ëŠ” ë°©ì‹ì€ WorkerNodeì— Daemonìœ¼ë¡œ ë„ìš¸ìˆ˜ë„ ìˆê³ , Podì— Sidecar Patternìœ¼ë¡œ ë„ìš¸ ìˆ˜ë„ ìˆë‹¤.  
ì´ë²ˆì— ì ìš©í•œ ê²ƒì€ Podì— Sidecar Patternìœ¼ë¡œ Containerë¥¼ í•˜ë‚˜ ë” ë„ì›Œ ì§„í–‰í•˜ëŠ” ê²ƒìœ¼ë¡œ í•˜ì˜€ë‹¤.  

ì•„ë˜ì™€ ê°™ì´ deployment.yamlì— ê¸°ì¡´ main-api ì»¨í…Œì´ë„ˆ ì´ì™¸ì˜ Sidecarí˜•ì‹ìœ¼ë¡œ xray-daemon ì»¨í…Œì´ë„ˆë¥¼ ì ìš©í•˜ì˜€ë‹¤.  
```yaml
containers:
  - name: xray-daemon
    image: amazon/aws-xray-daemon
    imagePullPolicy: Always
    ports:
      - containerPort: 2000
        name: xray
        protocol: UDP
    resources:
      requests:
        cpu: 50m
        memory: 50Mi
    env:
      - name: AWS_REGION
        value: "ap-northeast-2"
```

#### XRay Local daemon ì„¤ì •
X-Rayë¥¼ ë¡œì»¬ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ í•  ìˆ˜ë„ ìˆë‹¤. ê°œë°œ ë‹¨ê³„ì—ì„œëŠ” [Local í™˜ê²½ì— Daemonì„ Download](https://docs.aws.amazon.com/xray/latest/devguide/xray-daemon.html#xray-daemon-downloading)í•˜ì—¬ ì‹¤í–‰ì‹œí‚¤ê³  í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•˜ë‹¤.  
```bash
./xray_mac -o -n ap-northeast-2
```




<br>


## Application ì„¤ì •
- Env 
  - Spring Boot 2.7.5
  - Gradle 7.5
  - XRay com.amazonaws:aws-xray-recorder-sdk-bom:2.13.0
  - EKS 1.24


### XRay for AWS SDK
`build.gradle`  
ë‹¤ë¥¸ AWS SDKë¥¼ ê³„ì¸¡í•˜ê¸° ìœ„í•´ì„œëŠ” ì•„ë˜ ë¬¸ì„œì™€ ê°™ì´ aws-xray-recorder-sdk-aws-sdk-v2-instrumentorë¥¼ ì œê±°í•˜ê³  aws-xray-recorder-sdk-aws-sdk-v2 ëª¨ë“ˆì„ ì¶”ê°€í•œë‹¤. 
[Tracing AWS SDK calls with the X-Ray SDK for Java](https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-java-awssdkclients.html)

```groovy
dependencyManagement {
    imports {
        mavenBom('com.amazonaws:aws-xray-recorder-sdk-bom:2.13.0')
    }
}
dependencies {
   // XRay
    implementation("com.amazonaws:aws-xray-recorder-sdk-spring")
    implementation("org.springframework.boot:spring-boot-starter-aop")
    implementation("com.amazonaws:aws-xray-recorder-sdk-core")
    implementation("com.amazonaws:aws-xray-recorder-sdk-aws-sdk")
//    implementation("com.amazonaws:aws-xray-recorder-sdk-aws-sdk-v2-instrumentor")
    implementation("com.amazonaws:aws-xray-recorder-sdk-aws-sdk-v2") // v2-instrumentor ëŒ€ì²´
    implementation("com.amazonaws:aws-xray-recorder-sdk-slf4j")
    implementation("com.amazonaws:aws-xray-recorder-sdk-apache-http")
    implementation("com.amazonaws:aws-xray-recorder-sdk-sql-mysql")
}
```

`XRayConfig.java`  
```java
package com.bys.aws.main.config;

@Slf4j
@Configuration
public class XRayConfig {

    @Value("${xray.name}")
    private String XRAY_APP_NAME;

    static {
        AWSXRayRecorderBuilder builder = AWSXRayRecorderBuilder
                .standard()
                .withSegmentListener(new SLF4JSegmentListener("bys-xray"))
                .withPlugin(new EC2Plugin())
                .withPlugin(new EKSPlugin());

        URL ruleFile = XRayConfig.class.getResource("/awssdk-xray-rules.json");
        log.debug("xrayRuleFile: " + ruleFile.getFile());
        builder.withSamplingStrategy(new CentralizedSamplingStrategy(ruleFile));
        AWSXRay.setGlobalRecorder(builder.build());
    }

    @Bean
    public Filter TracingFilter() {
        log.debug("The segment name for aws xray tracking has been set to {}.", XRAY_APP_NAME);
        return new AWSXRayServletFilter(
                Optional.ofNullable(XRAY_APP_NAME).orElseThrow()
        );
    }
}
```

`XRayInspector.java`  
```java
package com.bys.aws.main.config;

@Slf4j
@Aspect
@Component
public class XRayInspector extends BaseAbstractXRayInterceptor {

    @Override
    @Pointcut("@within(com.amazonaws.xray.spring.aop.XRayEnabled) && (bean(*Controller) || bean(*Service) || bean(*Client))")
    public void xrayEnabledClasses() {}

    @Override
    protected Map<String, Map<String, Object>> generateMetadata(ProceedingJoinPoint proceedingJoinPoint, Subsegment subsegment) {
        return super.generateMetadata(proceedingJoinPoint, subsegment);
    }
}
```

`resources/awssdk-xray-rules.json`  
```json
{
  "version": 2,
  "rules": [
    {
      "description": "awssdk-storage-dev",
      "host": "*",
      "http_method": "*",
      "url_path": "/storage/*",
      "fixed_target": 0,
      "rate": 0.5
    }
  ],
  "default": {
    "fixed_target": 1,
    "rate": 0.1
  }
}
```

`S3Client ì˜ˆì‹œ`  
AWS SDK Java 2.X ë¶€í„°ëŠ” overrideConfigurationì„ í†µí•´ TracingInterceptorë¥¼ ì¶”ê°€í•œë‹¤.  
```java
package com.bys.aws.main.config;

@Slf4j
@Component
public class AWSSDKConfig {

    Region region = Region.AP_NORTHEAST_2;

    @Bean
    public S3Client getStsClient()
    {
        return S3Client.builder()
                .overrideConfiguration(ClientOverrideConfiguration.builder()
                        .addExecutionInterceptor(new TracingInterceptor())
                        .build())
                .region(region)
                .build();
    }
}
```

<br>

ê¸°ë³¸ì ìœ¼ë¡œ ë°ëª¬ì€ 0.0.0.0:2000 í¬íŠ¸ë¡œ Listenì„ í•˜ê³  ìˆìœ¼ë©°, Applicationì—ì„œëŠ” AWS SDKë¥¼ ì ìš©í•˜ì—¬ AWSXRayServletFilterë¥¼ ì…‹ì—…í•˜ë©´ localhost:2000 í¬íŠ¸ë¡œ Segmentë¥¼ ì „ë‹¬í•˜ê²Œ ë˜ì–´ìˆë‹¤.  
aws-xray-recorder-sdk-core/DaemonConfiguration.class íŒŒì¼ì—ì„œëŠ” DEFAULT_ADDRESS="127.0.0.1:2000"ìœ¼ë¡œ ì…‹íŒ…ë˜ì–´ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  

ì´ëŸ° ê°’ë“¤ì€ í™˜ê²½ë³€ìˆ˜, ì‹œìŠ¤í…œë³€ìˆ˜ë¥¼(com.amazonaws.xray.emitters.daemonAddress or AWS_XRAY_DAEMON_ADDRESS) í†µí•´ ë³€ê²½í•  ìˆ˜ ìˆìœ¼ë©° DAEMON_ADDRESS ì™¸ì—ë„ ë‹¤ë¥¸ í™˜ê²½ë³€ìˆ˜ ê°’ì„ í†µí•´ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ê°’ë“¤ì´ ì¡´ì¬í•œë‹¤.  

![xray_awssdk.png](/assets/it/cloud/eks/xray_awssdk.png){: width="60%" height="auto"}  

<br>

### XRay for outgoing request
Httpìš”ì²­ì— ëŒ€í•œ XRayë¥¼ í…ŒìŠ¤íŠ¸ í•˜ê¸° ìœ„í•´ì„œ ìœ„ ê·¸ë¦¼ì—ì„œ bys-awssdk-storage-dev ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ bys-awssdk-iam-dev ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ í˜¸ì¶œí•˜ì—¬ í˜„ì¬ í˜¸ì¶œí•˜ê³  ìˆëŠ” IAM Identityë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ì‘ì—…ì„ ì§„í–‰í–ˆë‹¤.  
ë¬¸ì œëŠ” WebClientë¥¼ ì‚¬ìš©í•˜ì—¬ Http ìš”ì²­ì„ í•˜ì˜€ìœ¼ë‚˜ ìœ„ ê·¸ë¦¼ ìƒì—ì„œ ì¶”ì ì´ ë˜ì§€ ì•ŠëŠ” í˜„ìƒì´ ë°œìƒ ë˜ì—ˆë‹¤. (ì˜ˆìƒ í˜¸ì¶œ ê·¸ë¦¼: bys-awssdk-storage-dev -> appmesh(bys-awssdk-iam-dev)) í™•ì¸ì„ í•´ë³´ë‹ˆ í˜„ì¬ëŠ” Apache clientsë¥¼ ì´ìš©í•œ HTTP ìš”ì²­ë§Œì„ ì§€ì›í•˜ê³  ìˆì—ˆë‹¤.  
ë”°ë¼ì„œ, FeignClientë¡œ ë³€ê²½í–ˆë‹¤.  

`XRayFeignClientConfig`  
```java
import com.amazonaws.xray.proxies.apache.http.HttpClientBuilder;
import lombok.extern.slf4j.Slf4j;
import org.apache.http.impl.client.CloseableHttpClient;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class XRayFeignClientConfig {

    @Bean
    public CloseableHttpClient feignClient() {
        CloseableHttpClient httpclient = HttpClientBuilder.create().build();
        return httpclient;
    }
}
```

`StsFeignClient`  
```java
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import java.util.HashMap;

@FeignClient(name = "sts-api", url = "${feign.apiurl.iam}")
public interface StsFeignClient {

    @GetMapping(value="/v2/sts/id", produces = "application/json", consumes = "application/json")
    public HashMap<String, String> getCallerId();
}
```

`S3ServiceV2`  
```java
@Slf4j
@Service
@RequiredArgsConstructor
public class S3ServiceV2 {

    private final S3Client s3Client;
    private final StsFeignClient stsFeignClient;

    public List<BucketModelV2> getBuckets() {
        HashMap<String, String> iamResponse = stsFeignClient.getCallerId();
        log.info("userId: " + iamResponse.get("userId"));
        log.info("account: " + iamResponse.get("account"));
        log.info("arn: " + iamResponse.get("arn"));

        List<BucketModelV2> buckets = new ArrayList<>();
        try {
            ListBucketsRequest listBucketsRequest = ListBucketsRequest.builder().build();
            ListBucketsResponse listBucketsResponse = s3Client.listBuckets(listBucketsRequest);
            listBucketsResponse.buckets().stream().forEach(x -> {
                buckets.add(new BucketModelV2(x.name(), x.creationDate()));
            });
        } catch (S3Exception e) {
            log.error(e.awsErrorDetails().errorMessage());
        }
        return buckets;
    }

    //convert bytes to kbs.
    private static long calKb(Long val) {
        return val/1024;
    }
}
```

`application-dev.yaml`  
```yaml
# Feign Setting
feign:
  httpclient:
    enabled: true
  client:
    config:
      sts-api: # Feign Client ëª…
        decode404: false
        loggerLevel: full
        connect-timeout: 3000
        readTimeout: 60000
  apiurl:
    ec2: http://awssdk-ec2-dev-svc.aws:10010/ec2
    storage: http://awssdk-storage-dev-svc.aws:10011/storage
    iam: http://awssdk-iam-dev-svc.aws:10012/iam
```

<br><br>




---

## ğŸ“š References

[1] **Tracing incoming requests**  
- https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-java-filters.html  

[2] **X-Ray SDK for Java**  
- https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-java.html

[3] **X-Ray SDK for Java Clients**  
- https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-java-awssdkclients.html 

[4] **WebClient Issue**  
- https://github.com/aws/aws-xray-java-agent/issues/87

[5] **Github - spring-boot-aws-xray-sample**  
- https://github.com/anthunt/spring-boot-aws-xray-sample

[6] **XRay Daemon Local**  
- https://docs.aws.amazon.com/xray/latest/devguide/xray-daemon-local.html#xray-daemon-local-linux  