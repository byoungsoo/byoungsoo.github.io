---
layout: post
title: "EKS Node ê·¸ë£¹"
author: "Bys"
category: cloud
date: 2023-05-08 01:00:00
tags: aws cloud eks node al2023
---

## 1. Amazon Linux 2
### EKS Node Bootstrap
1. AWSì—ì„œ ì œê³µí•˜ëŠ” eks-node AMIë¥¼ ì‚¬ìš©í•˜ë©° /etc/eks/bootstrap.sh í˜¸ì¶œ

2. Bootstrap populates several files and make API queries to EKS

3. Kubelet starts connects to the API server.

4. Kubelet tries to register itself, role must match

5. Kubelet creates Certificate Signing Request(CSR) and wait for it to be approved by EKS signer

6. Certificated is signed, kubelet downloads it and serve traffic using 10250 port
   - https://kubernetes.io/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/

<br>

### EKS Node AMI 

ê¸°ë³¸ì ìœ¼ë¡œ AMIê°€ ì„¤ì •ëœ Custom Launch Templateì„ ì‚¬ìš©í•˜ê²Œë˜ë©´ UserdataëŠ” ì‚¬ìš©ìì—ì„œ ì§€ì •í•´ì•¼ í•œë‹¤. ê·¸ë ‡ì§€ ì•Šì€ ëª¨ë“  ê²½ìš°ì—ëŠ” EKS ì„œë¹„ìŠ¤ì—ì„œ ìë™ìœ¼ë¡œ Injection í•´ì¤€ë‹¤.  

#### [Customized AMI Launch Template Userdata](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/launch-templates.html)
`Origin`  
```bash
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="==MYBOUNDARY=="

--==MYBOUNDARY==
Content-Type: text/x-shellscript; charset="us-ascii"

#!/bin/bash
set -ex
/etc/eks/bootstrap.sh my-cluster \
  --b64-cluster-ca certificate-authority \
  --apiserver-endpoint api-server-endpoint \
  --dns-cluster-ip service-cidr.10 \
  --container-runtime containerd \
  --kubelet-extra-args '--max-pods=my-max-pods-value' \
  --use-max-pods false

--==MYBOUNDARY==--
```


Optionalì„ ì œì™¸í•œ ì ìš©ê°€ëŠ¥ Userdata - í´ëŸ¬ìŠ¤í„°ëª…ë§Œ ë“¤ì–´ê°€ë©´ ëª¨ë‘ bootstrap.sh ì—ì„œ ì°¾ìŒ
```bash
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="==MYBOUNDARY=="

--==MYBOUNDARY==
Content-Type: text/x-shellscript; charset="us-ascii"

set -ex
/etc/eks/bootstrap.sh bys-dev-eks-main

--==MYBOUNDARY==--
```


kubeletì— ì¶”ê°€ì ì¸ íŒŒë¼ë¯¸í„° ì„¤ì •ì„ ìœ„ì„œ
`kubelet-extra-args`  
```bash
/etc/eks/bootstrap.sh cluster_name --kubelet-extra-args '--node-labels=something=hello,somethingelse=bye --register-with-taints=taint1=true'
```

[Bootstrap.sh](https://github.com/awslabs/amazon-eks-ami/blob/master/files/bootstrap.sh)ì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ kubeletì„ êµ¬ë™í•˜ê¸° ìœ„í•œ ì„¤ì • ë° ê°’ë“¤ì´ ì ìš©ëœë‹¤.  
ë²„ì „ì— ë”°ë¼ ì ìš©ë˜ëŠ” ë‚´ìš©ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ í•´ë‹¹ ë‚´ìš©ì„ ê¼­ ì°¸ê³ í•œë‹¤.  

<br>

---

## [2. Amazon Linux 2023](https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html#al2023)

- AL2023ì€ IMDSv2ê°€ ê¸°ë³¸ ì„¤ì • 
- AL2023ì€ cgroupv2 ê°€ ì‚¬ìš©ë¨
- AL2023 ë¶€í„°ëŠ” bootstrap.sh ì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©° [nodeadm í”„ë¡œì„¸ìŠ¤](https://awslabs.github.io/amazon-eks-ami/nodeadm/)ë¥¼ í†µí•´ì„œ node initialization í”„ë¡œì„¸ìŠ¤ê°€ ì‹œì‘ëœë‹¤. bootstrap.sh ì—ì„œëŠ” describeë¥¼ í†µí•´ í•„ìˆ˜ íŒŒë¼ë¯¸í„°ë¥¼ ì¡°íšŒí•˜ì˜€ì§€ë§Œ AL2023ì—ì„œëŠ” Throttling ë°©ì§€ë¥¼ ìœ„í•´ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ ì•„ë˜ì˜ í•„ìˆ˜ íŒŒë¼ë¯¸í„°ë¥¼ ëª¨ë‘ ì„¤ì •í•´ì•¼ í•œë‹¤.  

`Requirement Configuration`  
```yaml
---
apiVersion: node.eks.aws/v1alpha1
kind: NodeConfig
spec:
  cluster:
    name: my-cluster
    apiServerEndpoint: https://example.com
    certificateAuthority: Y2VydGlmaWNhdGVBdXRob3JpdHk=
    cidr: 172.20.0.0/16
```  

`Example`  
```yaml
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="BOUNDARY"

--BOUNDARY
Content-Type: application/node.eks.aws

---
apiVersion: node.eks.aws/v1alpha1
kind: NodeConfig
spec:
  cluster:
    name: my-cluster
    apiServerEndpoint: https://example.com
    certificateAuthority: Y2VydGlmaWNhdGVBdXRob3JpdHk=
    cidr: 172.20.0.0/16

--BOUNDARY--
Content-Type: application/node.eks.aws

---
apiVersion: node.eks.aws/v1alpha1
kind: NodeConfig
spec:
  kubelet:
    config:
      shutdownGracePeriod: 30s
      featureGates:
        DisableKubeletCloudCredentialProviders: true

--BOUNDARY--
```

`Injected Userdata`
```bash
# cat user-data.txt
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="//"

--//
Content-Type: application/node.eks.aws

---
apiVersion: node.eks.aws/v1alpha1
kind: NodeConfig
spec:
  cluster:
    apiServerEndpoint: https://1111122222.sk1.ap-northeast-2.eks.amazonaws.com
    certificateAuthority: Y2VydGlmaWNhdGVBdXRob3JpdHk==
    cidr: 172.20.0.0/16
    name: my-cluster
  kubelet:
    config:
      shutdownGracePeriod: 30s
      featureGates:
        DisableKubeletCloudCredentialProviders: true
      maxPods: 17
      clusterDNS:
      - 172.20.0.10
    flags:
    - "--node-labels=eks.amazonaws.com/nodegroup-image=ami-057051082a0861071,eks.amazonaws.com/capacityType=ON_DEMAND,eks.amazonaws.com/nodegroup=ng-al2023"
  # instance:
  #   localStorage: 
  #     strategy: 
  # containerd:
  #   config: |
  #     [plugins."io.containerd.grpc.v1.cri".containerd]
  #     discard_unpacked_layers = false

--//--
```

<br>

---

## [EKS managed node upgrade](https://docs.aws.amazon.com/eks/latest/userguide/managed-node-update-behavior.html)

- [Cluster Upgrade Best Practice](https://aws.github.io/aws-eks-best-practices/upgrades/)

EKS í´ëŸ¬ìŠ¤í„° ë²„ì „ì„ ì—…ë°ì´íŠ¸ í•œ ì´ í›„, EKS managed node groupì— ëŒ€í•œ ë²„ì „ ì—…ë°ì´íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ìŠ¤í…ìœ¼ë¡œ ì§„í–‰ëœë‹¤. 

1. ë…¸ë“œ ê·¸ë£¹ì˜ maximum unavailable ì„¤ì • ê°’ ê¹Œì§€ ì—…ê·¸ë ˆì´ë“œí•´ì•¼ í•˜ëŠ” ë…¸ë“œë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ íƒí•œë‹¤. 
2. ë…¸ë“œì—ì„œ Podsë¥¼ Draining í•œë‹¤. Podsê°€ 15ë¶„ ì´ë‚´ì— ë…¸ë“œë¥¼ ë– ë‚˜ì§€ ì•Šê³  force í”Œë˜ê·¸ê°€ ì—†ìœ¼ë©´ PodEvictionFailure ì˜¤ë¥˜ì™€ í•¨ê»˜ ì—…ê·¸ë ˆì´ë“œ ë‹¨ê³„ê°€ ì‹¤íŒ¨í•œë‹¤. ì´ ê²½ìš°ì—ëŠ” force í”Œë˜ê·¸ë¥¼ ì ìš©í•˜ì—¬ Podsë¥¼ ê°•ì œë¡œ ì‚­ì œí•  ìˆ˜ ìˆë‹¤. 
3. ëª¨ë“  Podê°€ evictionë˜ë©´ ë…¸ë“œë¥¼ Cordoní•˜ê³  60ì´ˆë¥¼ ê¸°ë‹¤ë¦°ë‹¤. ì´ ì‘ì—…ì€ service controllerê°€ ì´ ë…¸ë“œì— ìƒˆ ìš”ì²­ì„ ë³´ë‚´ì§€ ì•Šê³  active ë…¸ë“œ ëª©ë¡ì—ì„œ ì´ ë…¸ë“œë¥¼ ì œê±°í•˜ë„ë¡ í•˜ê¸° ìœ„í•´ ìˆ˜í–‰ëœë‹¤. 
4. Cordon ë…¸ë“œë¥¼ ìœ„í•´ Auto Scaling ê·¸ë£¹ì— ì¢…ë£Œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
5. ì´ì „ ë²„ì „ì˜ ì‹œì‘ í…œí”Œë¦¿ìœ¼ë¡œ ë°°í¬ëœ ë…¸ë“œ ê·¸ë£¹ì— ë…¸ë“œê°€ ì—†ì„ ë•Œê¹Œì§€ ì´ì „ ì—…ê·¸ë ˆì´ë“œ ë‹¨ê³„ë¥¼ ë°˜ë³µí•©ë‹ˆë‹¤.

ì´ ë‹¨ê³„ì—ì„œ PodEvictionFailure ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ì„ ìˆ˜ ìˆë‹¤.
- Aggressive PDB (Aggressive PDBê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°)  
Aggressive PDB is defined on the Pod or there are multiple PDBs pointing to the same Pod.
- Deployment tolerating all the taints (ëª¨ë“  Taintë¥¼ í—ˆìš©í•˜ëŠ” Tolerationì„ ê°€ì§„ Podê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°)  
Once every Pod is evicted, it's expected for the node to be empty because the node is tainted in the earlier steps. However, if the deployment tolerates every taint, then the node is more likely to be non-empty, leading to Pod eviction failure.
- Subnetì˜ IPë¶€ì¡±ìœ¼ë¡œ ì¸í•˜ì—¬ ì‹ ê·œ íŒŒë“œê°€ ìƒì„±ì´ ë˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ëŠ” Pod evictionì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆë‹¤.    
NodeCreationFailure	Couldn't proceed with upgrade process as new nodes are not joining node group ng-v1


<br>

---

## [3. Bottlerocket](https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami-bottlerocket.html)  

ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ng-bottlerocket.yaml íŒŒì¼ì„ ìƒì„±í•˜ì—¬ `eksctl create nodegroup -f ng-bottlerocket.yaml` ì»¤ë§¨ë“œë¥¼ í†µí•´ ìƒì„±í•  ìˆ˜ ìˆë‹¤.  
```yaml
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: bys-dev-eks-sec
  region: ap-northeast-2

vpc:
  id: "vpc-0ca96cd5c37d3bae8"
  subnets:
    private:
      bys-dev-sbn-az1-app:
          id: "subnet-0ea5be4984975e8ed"
      bys-dev-sbn-az2-app:
          id: "subnet-0b4076508ce121c27"

managedNodeGroups:
  - name: ng-bottlerocket
    amiFamily: Bottlerocket
    instanceType: m5.large
    volumeSize: 20
    minSize: 2
    maxSize: 4
    desiredCapacity: 2
    privateNetworking: true
    subnets:
      - bys-dev-sbn-az1-app
      - bys-dev-sbn-az2-app
    ssh:
      allow: true
      publicKeyName: "bys-console"
    tags:
      auto-delete: "no"
```

Custom AMIë¥¼ ì‚¬ìš©í•˜ëŠ” LTë¥¼ í†µí•´ Bottlerocketì„ ì´ìš©í•  ë•ŒëŠ” ë‹¤ìŒê³¼ ê°™ì´ userdataë¥¼ ì •ì˜í•  ìˆ˜ ìˆë‹¤. [ì°¸ê³ . Description of settings](https://github.com/bottlerocket-os/bottlerocket?tab=readme-ov-file#description-of-settings)

```bash
settings.kubernetes.cluster-name = 'bys-dev-eks-sec'
settings.kubernetes.api-server = 'https://A2FAB60F0DBB94CDCD057CE2227F2252.yl4.ap-northeast-2.eks.amazonaws.com'
settings.kubernetes.cluster-certificate = '=='
settings.kubernetes.cluster-dns-ip = '172.20.0.10'
settings.kubernetes.max-pods = 20
settings.kubernetes.node-labels.'eks.amazonaws.com/sourceLaunchTemplateVersion' = '1'
settings.kubernetes.node-labels.'alpha.eksctl.io/cluster-name' = 'bys-dev-eks-sec'
settings.kubernetes.node-labels.'alpha.eksctl.io/nodegroup-name' = 'ng-bottlerocket'
settings.kubernetes.node-labels.'eks.amazonaws.com/nodegroup-image' = 'ami-0c0c53d11a3f898ea'
settings.kubernetes.node-labels.'eks.amazonaws.com/capacityType' = 'ON_DEMAND'
settings.kubernetes.node-labels.'eks.amazonaws.com/nodegroup' = 'ng-bottlerocket'
settings.kubernetes.node-labels.'eks.amazonaws.com/sourceLaunchTemplateId' = 'lt-05fd1822cf902ddbe'
settings.host-containers.admin.enabled = true
```

ë˜ëŠ”

```
[settings.host-containers.admin]
enabled = true

[settings.kubernetes]
cluster-name = 'bys-dev-eks-ue1'
api-server = 'https://DD583EB3684AFF562F6D89388683AB87.gr7.us-east-1.eks.amazonaws.com'
cluster-certificate = ''
node-labels.'label-key' = 'label-value'
```



[Bottlerocket log í™•ì¸í•˜ëŠ” ë°©ë²•](https://github.com/bottlerocket-os/bottlerocket/blob/develop/README.md#logs)
```bash
# Access admin container  
$ apiclient exec admin bash

# Get a full root shell
$ sudo sheltie

# Obtain an archive of log 
$ logdog
......
logs are at: /var/log/support/bottlerocket-logs.tar.gz

# To get bottlerocket log from node
kubectl get --raw "/api/v1/nodes/<node-name>/proxy/logs/support/bottlerocket-logs.tar.gz" > bottlerocket-logs.tar.gz
```

<br>

---

## [4. GPU](https://docs.aws.amazon.com/ko_kr/batch/latest/userguide/run-eks-gpu-workload.html)  
EKSì—ì„œ GPUëŠ” ì£¼ë¡œ Nvidia ì‚¬ì˜ ì¹©ì„ ì‚¬ìš©í•œë‹¤. Nvidiaì˜ ì œí’ˆêµ°ìœ¼ë¡œëŠ” Nvidia Teslaê°€ ì¡´ì¬í•˜ë©° ëŒ€ëµì ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ë‹¤.  
```txt
2007ë…„: Tesla C80 (G80 ì•„í‚¤í…ì²˜)
2009ë…„: Tesla M10 (GT200 ì•„í‚¤í…ì²˜)
2010ë…„: Tesla S10 (Fermi ì•„í‚¤í…ì²˜)
2012ë…„: Tesla K10, K20 (Kepler ì•„í‚¤í…ì²˜)
2013ë…„: Tesla K40 (Kepler ì•„í‚¤í…ì²˜)
2014ë…„: Tesla M40 (Maxwell ì•„í‚¤í…ì²˜)
2016ë…„: Tesla P40, P100 (Pascal ì•„í‚¤í…ì²˜)
2017ë…„: Tesla V100 (Volta ì•„í‚¤í…ì²˜)
2018ë…„: Tesla T40 (Turing ì•„í‚¤í…ì²˜)
2019ë…„: Tesla A100 (Ampere ì•„í‚¤í…ì²˜)
2020ë…„: Tesla A30, A40 (Ampere ì•„í‚¤í…ì²˜)
......
2023ë…„: L4 (Ada Lovelace ì•„í‚¤í…ì²˜)
2023ë…„: H100 (Hopper ì•„í‚¤í…ì²˜)
2024ë…„: H200 (Hopper ì•„í‚¤í…ì²˜)
2024ë…„: GB200 NVL72 (Blackwell ì•„í‚¤í…ì²˜)
```
2020ë…„ 5ì›” ë¶€í„° NvidiaëŠ” í…ŒìŠ¬ë¼ ë¸Œëœë“œë¥¼ ì¤‘ë‹¨í•˜ê³ , [ë°ì´í„° ì„¼í„°](https://www.nvidia.com/en-us/data-center/products/) GPU ì œí’ˆìœ¼ë¡œ ì´ë¦„ì„ ë³€ê²½í•˜ì˜€ë‹¤. 
Nvidia GPU ì´ë¦„ì—ì„œ ë³¼ ìˆ˜ ìˆëŠ” Tensor CoreëŠ” Nvidiaì˜ ì¸ê³µì§€ëŠ¥(AI) ë° ê³ ì„±ëŠ¥ ì»´í“¨íŒ…(HPC) ë¶„ì•¼ì—ì„œ ë³µì¡í•œ ê³„ì‚°ì„ í–¥ìƒì‹œí‚¤ë„ë¡ ì„¤ê³„ëœ ì „ìš© í•˜ë“œì›¨ì–´ ê°€ì†ê¸°ë¡œ Volta ì•„í‚¤í…ì²˜ì— ì²˜ìŒ ë„ì…ëœ í›„ Turing, Ampere, Ada Lovelace, Hopper, Blackwell ì•„í‚¤í…ì²˜ ë“±ì— ì§€ì†ì ìœ¼ë¡œ ì ìš©ë˜ê³  ìˆë‹¤.  

<br>

### [AWS GPU Node](https://docs.aws.amazon.com/ko_kr/dlami/latest/devguide/gpu.html)
Amazon EC2ì—ëŠ” P3, P4, G3, G4, G5 ë“±ì˜ íƒ€ì…ì´ ì¡´ì¬í•˜ë©° ê° ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì— ë”°ë¼ Tesla V100, A100 ë“±ì˜ GPUê°€ íƒ‘ì¬ëœë‹¤. ë˜í•œ AWSì—ì„œëŠ” Graviton ì´ë¼ê³  í•˜ëŠ” ARMê¸°ë°˜ì˜ GPUë¥¼ ì œê³µí•˜ëŠ”ë° í˜„ì¬ G5g ì¸ìŠ¤í„´ìŠ¤íƒ€ì…ì—ëŠ” [NVIDIA T4G Tensor Core GPU](https://d1.awsstatic.com/product-marketing/ec2/NVIDIA_AWS_T4G_DataSheet_FINAL_02_17_2022.pdf)ê°€ íƒ‘ì¬ë˜ì–´ ìˆë‹¤. ì´ GPUëŠ” ARM ê¸°ë°˜ í”„ë¡œì„¸ì„œì—ì„œ ë™ì‘í•˜ë„ë¡ ì„¤ê³„ëœ Nvidia GPUë‹¤.  
- Amazon EC2 P3 ì¸ìŠ¤í„´ìŠ¤ì—ëŠ” ìµœëŒ€ 8ê°œì˜ NVIDIA Tesla V100 GPUê°€ ìˆìŠµë‹ˆë‹¤.
- Amazon EC2 P4 ì¸ìŠ¤í„´ìŠ¤ì—ëŠ” ìµœëŒ€ 8ê°œì˜ NVIDIA Tesla A100 GPUê°€ ìˆìŠµë‹ˆë‹¤.
- Amazon EC2 G3 ì¸ìŠ¤í„´ìŠ¤ì—ëŠ” ìµœëŒ€ 4ê°œì˜ NVIDIA Tesla M60 GPUê°€ ìˆìŠµë‹ˆë‹¤.
- Amazon EC2 G4 ì¸ìŠ¤í„´ìŠ¤ì—ëŠ” ìµœëŒ€ 4ê°œì˜ NVIDIA T4 GPUê°€ ìˆìŠµë‹ˆë‹¤.
- Amazon EC2 G5 ì¸ìŠ¤í„´ìŠ¤ì—ëŠ” ìµœëŒ€ 8ê°œì˜ NVIDIA A10G GPUê°€ ìˆìŠµë‹ˆë‹¤.
- Amazon EC2 G5g ì¸ìŠ¤í„´ìŠ¤ì—ëŠ” ARM ê¸°ë°˜ AWS Graviton2 í”„ë¡œì„¸ì„œê°€ íƒ‘ì¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

<br>

### [EKS GPU](https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html#gpu-ami)
EKS í´ëŸ¬ìŠ¤í„°ì— GPU ë…¸ë“œë¥¼ ì„¤ì¹˜í•˜ê¸° ìœ„í•´ì„œëŠ” GPU ê¸°ë°˜ì˜ ìµœì í™” ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤. [EKS AMI Release](https://github.com/awslabs/amazon-eks-ami/releases)ë¥¼ í™•ì¸í•˜ë©´ AL2_x86_64_GPU ì´ë¯¸ì§€ì—ëŠ” efa(Elastic Fabric Adapter, ê³ ì„±ëŠ¥ ì»´í“¨íŒ…(HPC) ë° ë¨¸ì‹  ëŸ¬ë‹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì„±ëŠ¥ì„ í¬ê²Œ í–¥ìƒì‹œí‚¤ëŠ” ë„¤íŠ¸ì›Œí¬ ë””ë°”ì´ìŠ¤), cuda-12-2, nvidia-driver-latest-dkms ë“±ì˜ íŒ¨í‚¤ì§€ê°€ ê¸°ë³¸ì ìœ¼ë¡œ ì„¤ì¹˜ëœ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.  

the accelerated AMI includes the following: 
- NVIDIA drivers
- The nvidia-container-runtime (as the default runtime)
- AWS Neuron container runtime

<br>

#### [NVIDIA device plugin for Kubernetes](https://github.com/NVIDIA/k8s-device-plugin)
ì¿ ë²„ë„¤í‹°ìŠ¤ NVIDIA device plugin ì´ë€ GPUë…¸ë“œì— ìˆëŠ” GPUë¥¼ ì‚¬ìš©ê°€ëŠ¥í•˜ë„ë¡ í•˜ëŠ” Device ì¥ì¹˜ë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” GPU ê°™ì€ íŠ¹ìˆ˜ í•˜ë“œì›¨ì–´ ë¦¬ì†ŒìŠ¤ë¥¼ ì§ì ‘ ê´€ë¦¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— NVIDIA device pluginì„ ì‚¬ìš©í•˜ì—¬ ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ NVIDIA GPUë¥¼ ì¸ì‹í•˜ê³  ì´ë¥¼ ì»¨í…Œì´ë„ˆì— í• ë‹¹í•  ìˆ˜ ìˆê²Œ í•´ì•¼í•œë‹¤[5]. 
ë§Œì•½, Nvidia device pluginì„ ë°°í¬í•˜ì§€ ì•Šê³ , `nvidia.com/gpu` ë¦¬ì†ŒìŠ¤ë¥¼ ìš”ì²­í•˜ëŠ” íŒŒë“œë¥¼ ë°°í¬í•˜ë©´ gpu ë…¸ë“œê°€ ì¡´ì¬í•˜ë”ë¼ë„ pending ìƒíƒœë¡œ ìŠ¤ì¼€ì¤„ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.  

- Node describe  
`Before install nvidia-device-plugin`
```
â”‚ Capacity:
â”‚   cpu:                4
â”‚   ephemeral-storage:  20959212Ki
â”‚   hugepages-1Gi:      0
â”‚   hugepages-2Mi:      0
â”‚   memory:             16069028Ki
â”‚   pods:               29
â”‚ Allocatable:
â”‚   cpu:                3920m
â”‚   ephemeral-storage:  18242267924
â”‚   hugepages-1Gi:      0
â”‚   hugepages-2Mi:      0
â”‚   memory:             15378852Ki
â”‚   pods:               29
```

`After install nvidia-device-plugin`
```
â”‚ Capacity:
â”‚   cpu:                4
â”‚   ephemeral-storage:  20959212Ki
â”‚   hugepages-1Gi:      0
â”‚   hugepages-2Mi:      0
â”‚   memory:             16069028Ki
â”‚   nvidia.com/gpu:     1
â”‚   pods:               29
â”‚ Allocatable:
â”‚   cpu:                3920m
â”‚   ephemeral-storage:  18242267924
â”‚   hugepages-1Gi:      0
â”‚   hugepages-2Mi:      0
â”‚   memory:             15378852Ki
â”‚   nvidia.com/gpu:     1
â”‚   pods:               29
```


**[Deployment via helm](https://github.com/NVIDIA/k8s-device-plugin?tab=readme-ov-file#deployment-via-helm)**
```bash
helm upgrade -i nvdp nvdp/nvidia-device-plugin \
  --namespace nvidia-device-plugin \
  --create-namespace \
  --version 0.15.0
```

**[Deployment via manifest](https://github.com/NVIDIA/k8s-device-plugin/blob/main/deployments/static/nvidia-device-plugin.yml)**
`Change version vX.X.X to release version`. Refer to [release version](https://github.com/NVIDIA/k8s-device-plugin/releases)
```
kubectl apply -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/vX.X.X/deployments/static/nvidia-device-plugin.yml
```
ì´ ë•Œ ê¸°ë³¸ìœ¼ë¡œ ì ìš©ë˜ëŠ” [values.yaml](https://github.com/NVIDIA/k8s-device-plugin/blob/main/deployments/helm/nvidia-device-plugin/values.yaml#L64)íŒŒì¼ì˜ íŠ¹ì • Affinityê°€ ì ìš©ë˜ë„ë¡ GPU ë…¸ë“œì˜ ë ˆì´ë¸”ì„ ì¶”ê°€í•´ì¤€ë‹¤.  


ì •ìƒì ì¸ ë°°í¬ê°€ ì™„ë£Œë˜ë©´ nvidia-device-pluginì´ Running ìƒíƒœê°€ ë˜ê³ , `nvidia.com/gpu` ë¦¬ì†ŒìŠ¤ë¥¼ ìš”ì²­í•˜ëŠ” íŒŒë“œëŠ” ì •ìƒ ìƒì„±ëœë‹¤.  
```bash
$ k get po -n nvidia-device-plugin
NAME                              READY   STATUS    RESTARTS   AGE
nvdp-nvidia-device-plugin-srhsw   1/1     Running   0          3m30s
```

ì´ í›„ nvidia-smi(System Management Interface)ë¥¼ í†µí•´ ì •ë³´ë¥¼ ì¶œë ¥í•´ ë³¼ ìˆ˜ ìˆë‹¤. ì´ë¥¼ í†µí•´ Nvidia Driver ë²„ì „ 535.161.08ì„ ì‚¬ìš©í•˜ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.  
```bash
$ kubectl logs -f nvidia-smi

Mon May 27 04:39:23 2024
+---------------------------------------------------------------------------------------+
| NVIDIA-SMI 535.161.08             Driver Version: 535.161.08   CUDA Version: 12.4     |
|-----------------------------------------+----------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |
|                                         |                      |               MIG M. |
|=========================================+======================+======================|
|   0  Tesla T4                       On  | 00000000:00:1E.0 Off |                    0 |
| N/A   26C    P8              11W /  70W |      0MiB / 15360MiB |      0%      Default |
|                                         |                      |                  N/A |
+-----------------------------------------+----------------------+----------------------+

+---------------------------------------------------------------------------------------+
| Processes:                                                                            |
|  GPU   GI   CI        PID   Type   Process name                            GPU Memory |
|        ID   ID                                                             Usage      |
|=======================================================================================|
|  No running processes found                                                           |
+---------------------------------------------------------------------------------------+
```

<br>

#### [NVIDIA GPU Operator with Amazon EKS](https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/amazon-eks.html#nvidia-gpu-operator-with-amazon-eks)  
EKS ìµœì í™” AMIì™€ NVIDIA device plugin for Kubernetesë¥¼ ë°°í¬í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ê°€ì¥ ê¸°ë³¸ì„¤ì •ì´ì§€ë§Œ ëª‡ ê°€ì§€ ì œì•½ì‚¬í•­ì´ ì¡´ì¬í•œë‹¤. 
  1. AMIì— ì„¤ì¹˜ë˜ì–´ ë¦´ë¦¬ì¦ˆë˜ëŠ” NVIDIA GPU driver ë²„ì „ê³¼ NVIDIA container runtime ë²„ì „ì€ Nvidiaì—ì„œ ë¦´ë¦¬ì¦ˆí•˜ëŠ” ì¼ì •ë³´ë‹¤ ëŠë¦¬ë‹¤. 
  2. NVIDIA device pluginì„ í•­ìƒ ë°°í¬í•´ì•¼ í•˜ë©°, ì‚¬ìš©ìê°€ ì—…ê·¸ë ˆì´ë“œë¥¼ í†µí•´ ë²„ì „ì„ ê´€ë¦¬í•´ì•¼ í•œë‹¤.  

ìœ„ ì œì•½ì‚¬í•­ì„ ìˆ˜ìš©í•  ìˆ˜ ìˆë‹¤ë©´ ìµœì í™” ì´ë¯¸ì§€ì— Nvidia ì¥ì¹˜ í”ŒëŸ¬ê·¸ì¸ì„ ì§ì ‘ ë°°í¬(ì„¤ì¹˜)í•˜ì—¬ ì‚¬ìš©í•˜ë©´ ë˜ì§€ë§Œ, ì´ëŸ¬í•œ ì œì•½ì‚¬í•­ì„ ë²—ì–´ë‚˜ê¸° ìœ„í•´ì„œëŠ” NVIDIA GPU Operatorë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.  

- Installing
  - https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/getting-started.html#install-gpu-operator


<br>

---

## 5. EKS Windows node
Windows ë…¸ë“œë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” [Windows ë¬¸ì„œ](https://docs.aws.amazon.com/eks/latest/userguide/windows-support.html)ë¥¼ í™•ì¸í•  í•„ìš”ê°€ ìˆë‹¤. 
#### Summary  
- í•˜ë‚˜ ì´ìƒì˜ Linux ë…¸ë“œë¥¼ ë°˜ë“œì‹œ í¬í•¨í•´ì•¼í•œë‹¤.
- Windows ë…¸ë“œì˜ groupìœ¼ë¡œ `eks:kube-proxy-windows` ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•œë‹¤.  

  ```yaml
  mapRoles:
  ----
  - groups:
    - system:bootstrappers
    - system:nodes
    rolearn: arn:aws:iam::558846430793:role/eksctl-bys-dev-eks-win-nodegroup-NodeInstanceRole-1MIR40S58HUY7
    username: system:node:{{EC2PrivateDNSName}}
  - groups:
    - system:bootstrappers
    - system:nodes
    - eks:kube-proxy-windows
    rolearn: arn:aws:iam::558846430793:role/eksctl-bys-dev-eks-win-nodegroup-NodeInstanceRole-VD0XFSFTRF2Q
    username: system:node:{{EC2PrivateDNSName}}
  ```
- Can't use SGP
- Can't use custom networking
- Can't use IPv6
- Number of Pods: Number of private IPv4 addresses for each interface on the node - 1

- amazon-vpc-cni ConfigMap ë°°í¬ (ì¤‘ìš”)
  ```yaml
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: amazon-vpc-cni
    namespace: kube-system
  data:
    enable-windows-ipam: "true"
  ```

  - ì´ ì‘ì—…ì„ ì§„í–‰í•˜ì§€ ì•Šìœ¼ë©´ íŒŒë“œì— IPê°€ í• ë‹¹ë˜ì§€ ì•Šìœ¼ë©° ì•„ë˜ì™€ ê°™ì€ ì˜¤ë¥˜ë©”ì„¸ì§€ê°€ í™•ì¸ëœë‹¤
    ```
    Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox "6a614a0ee5842556403f696a9d6b33347e622a1e5442ca5e07c29c90f925954d": plugin type="vpc-bridge" name="vpc" failed (add): failed to parse Kubernetes args: failed to get pod IP address windows-server-iis-797bf57f76-vwxgz: error executing k8s connector: error executing connector binary: exit status 1 with execution error: pod windows-server-iis-797bf57f76-vwxgz does not have label vpc.amazonaws.com/PrivateIPv4Address
    ```
  
  - IIS ì»¨í…Œì´ë„ˆ ê¸°ë™ì‹œ ì•½ 1ë¶„ 30ì´ˆ ì •ë„ì˜ ì‹œê°„ì´ ì†Œìš” ë˜ëŠ” ê²ƒì„ í™•ì¸

#### Creation  
```bash
eksctl create nodegroup \
    --region ap-northeast-2 \
    --cluster eks-win \
    --name ng-win-v1 \
    --node-type m5.large \
    --nodes 2 \
    --nodes-min 2 \
    --nodes-max 2 \
    --managed=false \
    --node-ami-family WindowsServer2022FullContainer

managedNodeGroups:
  - name: ng-win-v1
    amiFamily: WindowsServer2022FullContainer
    instanceType: m5.large
    volumeSize: 80
    minSize: 2
    maxSize: 2
    desiredCapacity: 2
    privateNetworking: true
    subnets:
      - subnet1
      - subnet2
    ssh:
      allow: true
      publicKeyName: "keypair"
    tags:
      auto-delete: "no"
```




---

## ğŸ“š References
